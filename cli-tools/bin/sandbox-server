#!/usr/bin/env bash
# Sandbox Server - Start the LangGraph sandbox server
#
# Usage: sandbox-server [options]
#
# Examples:
#   sandbox-server              # Start on default port 8080
#   sandbox-server --port 8085  # Start on custom port
#   sandbox-server --reload     # Start with hot reload
#   sandbox-server --bg         # Start in background
#   sandbox-server --one-shot   # Start, verify /health, stop (port 8085)

set -euo pipefail

PROJECT_DIR="/home/token/ProcAgentDir/langgraph-sandbox"
VENV_DIR="$PROJECT_DIR/.venv"
DEFAULT_PORT=8080

# Help
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    cat << 'EOF'
Sandbox Server - Start the LangGraph sandbox server

Usage: sandbox-server [options]

Starts the LangGraph sandbox FastAPI server using uvicorn.

Options:
  --port <port>   Port to listen on (default: 8080, or PORT env var)
  --reload        Enable hot reload for development
  --bg            Run in background (returns immediately)
  --stop          Stop any running sandbox server
  --status        Check if server is running
  --one-shot      Start server, verify /health, stop (default port: 8085)

Environment Variables:
  PORT            Default port if --port not specified
  UVICORN_RELOAD  Set to "true" for auto-reload

Endpoints:
  GET  /health                              Health check
  POST /api/management/invoices/upload-bundle   Invoice parsing
  POST /api/contracts/analyze-amendment     Contract amendment analysis

Examples:
  sandbox-server                    # Start foreground on port 8080
  sandbox-server --port 8085        # Start on port 8085
  sandbox-server --reload --bg      # Background with hot reload
  sandbox-server --stop             # Stop running server
  sandbox-server --one-shot         # Verify server starts/stops (port 8085)
  sandbox-server --one-shot --port 9000  # One-shot on custom port
EOF
    exit 0
fi

# Parse arguments
PORT="${PORT:-$DEFAULT_PORT}"
RELOAD=""
BACKGROUND=false
STOP=false
STATUS=false
ONE_SHOT=false

while [[ $# -gt 0 ]]; do
    case "$1" in
        --port|-p)
            PORT="$2"
            shift 2
            ;;
        --reload|-r)
            RELOAD="--reload"
            shift
            ;;
        --bg|--background)
            BACKGROUND=true
            shift
            ;;
        --stop)
            STOP=true
            shift
            ;;
        --status)
            STATUS=true
            shift
            ;;
        --one-shot)
            ONE_SHOT=true
            shift
            ;;
        *)
            echo "Unknown option: $1" >&2
            echo "Use --help for usage" >&2
            exit 1
            ;;
    esac
done

# One-shot mode defaults to port 8085 if not specified
if $ONE_SHOT && [[ "${PORT}" == "$DEFAULT_PORT" ]]; then
    PORT=8085
fi

# Status check
if $STATUS; then
    if pgrep -f "uvicorn app.main:app" >/dev/null 2>&1; then
        PID=$(pgrep -f "uvicorn app.main:app" | head -1)
        # Try to find the port
        LISTENING_PORT=$(ss -tlnp 2>/dev/null | grep "pid=$PID" | awk '{print $4}' | grep -oE '[0-9]+$' | head -1)
        echo "Sandbox server is running (PID: $PID, Port: ${LISTENING_PORT:-unknown})"
        exit 0
    else
        echo "Sandbox server is not running"
        exit 1
    fi
fi

# Stop server
if $STOP; then
    if pgrep -f "uvicorn app.main:app" >/dev/null 2>&1; then
        echo "Stopping sandbox server..."
        pkill -f "uvicorn app.main:app" || true
        sleep 1
        if pgrep -f "uvicorn app.main:app" >/dev/null 2>&1; then
            echo "Force killing..."
            pkill -9 -f "uvicorn app.main:app" || true
        fi
        echo "Stopped"
    else
        echo "No sandbox server running"
    fi
    exit 0
fi

# One-shot mode: Start server, verify /health, stop
if $ONE_SHOT; then
    echo "Running one-shot verification..."
    echo "  Port: $PORT"

    # Check if already running
    if pgrep -f "uvicorn app.main:app" >/dev/null 2>&1; then
        echo "Error: Sandbox server already running. Stop it first." >&2
        exit 1
    fi

    # Verify project exists
    if [[ ! -d "$PROJECT_DIR" ]]; then
        echo "Error: Project directory not found: $PROJECT_DIR" >&2
        exit 1
    fi

    if [[ ! -d "$VENV_DIR" ]]; then
        echo "Error: Virtual environment not found: $VENV_DIR" >&2
        exit 1
    fi

    # Start server in background
    CMD="source $VENV_DIR/bin/activate && cd $PROJECT_DIR && uvicorn app.main:app --host 0.0.0.0 --port $PORT"
    LOG_FILE="/tmp/sandbox-server-oneshot-$PORT.log"

    echo "Starting server..."
    nohup bash -c "$CMD" > "$LOG_FILE" 2>&1 &
    BG_PID=$!

    # Poll /health endpoint (max 30 seconds)
    echo "Waiting for server to be ready..."
    MAX_WAIT=30
    ELAPSED=0
    HEALTH_URL="http://localhost:$PORT/health"

    while [[ $ELAPSED -lt $MAX_WAIT ]]; do
        if curl -s -f "$HEALTH_URL" >/dev/null 2>&1; then
            echo "Server is ready!"
            HEALTH_RESPONSE=$(curl -s "$HEALTH_URL")
            echo ""
            echo "Health check response:"
            echo "$HEALTH_RESPONSE"
            echo ""

            # Stop the server
            echo "Stopping server..."
            kill $BG_PID 2>/dev/null || true
            sleep 1

            # Force kill if still running
            if kill -0 $BG_PID 2>/dev/null; then
                kill -9 $BG_PID 2>/dev/null || true
            fi

            echo "One-shot verification successful"
            exit 0
        fi

        # Check if process died
        if ! kill -0 $BG_PID 2>/dev/null; then
            echo "Error: Server process died unexpectedly" >&2
            echo "Log output:" >&2
            tail -20 "$LOG_FILE" 2>/dev/null
            exit 1
        fi

        sleep 1
        ELAPSED=$((ELAPSED + 1))
    done

    # Timeout - cleanup and fail
    echo "Error: Server did not become ready within $MAX_WAIT seconds" >&2
    echo "Log output:" >&2
    tail -20 "$LOG_FILE" 2>/dev/null

    kill $BG_PID 2>/dev/null || true
    sleep 1
    if kill -0 $BG_PID 2>/dev/null; then
        kill -9 $BG_PID 2>/dev/null || true
    fi

    exit 1
fi

# Check if already running
if pgrep -f "uvicorn app.main:app" >/dev/null 2>&1; then
    echo "Warning: Sandbox server already running. Use --stop first or --status to check." >&2
    exit 1
fi

# Verify project exists
if [[ ! -d "$PROJECT_DIR" ]]; then
    echo "Error: Project directory not found: $PROJECT_DIR" >&2
    exit 1
fi

if [[ ! -d "$VENV_DIR" ]]; then
    echo "Error: Virtual environment not found: $VENV_DIR" >&2
    exit 1
fi

# Build command
CMD="source $VENV_DIR/bin/activate && cd $PROJECT_DIR && uvicorn app.main:app --host 0.0.0.0 --port $PORT $RELOAD"

echo "Starting LangGraph Sandbox Server..."
echo "  Project: $PROJECT_DIR"
echo "  Port: $PORT"
[[ -n "$RELOAD" ]] && echo "  Reload: enabled"

if $BACKGROUND; then
    # Run in background
    LOG_FILE="/tmp/sandbox-server-$PORT.log"
    nohup bash -c "$CMD" > "$LOG_FILE" 2>&1 &
    BG_PID=$!
    sleep 2

    # Check if it started
    if kill -0 $BG_PID 2>/dev/null; then
        echo "  PID: $BG_PID"
        echo "  Log: $LOG_FILE"
        echo ""
        echo "Server started in background. Use 'sandbox-server --status' to check."
    else
        echo "Error: Server failed to start. Check $LOG_FILE" >&2
        tail -20 "$LOG_FILE" 2>/dev/null
        exit 1
    fi
else
    # Run in foreground
    echo ""
    exec bash -c "$CMD"
fi
