#!/usr/bin/env python3
"""Send test notification via Token-API.

Usage:
    notify-test                     # Test with default message
    notify-test "Custom message"    # Test with custom message
    notify-test --tts-only "msg"    # TTS only (no sound)
    notify-test --sound-only        # Sound only (no TTS)
    notify-test --list-voices       # List available TTS voices
"""

import sys
import json
import urllib.request

API_URL = "http://localhost:7777"


def send_request(endpoint, data=None):
    try:
        url = f"{API_URL}{endpoint}"
        if data:
            req = urllib.request.Request(
                url,
                data=json.dumps(data).encode(),
                headers={"Content-Type": "application/json"},
                method="POST"
            )
        else:
            req = urllib.request.Request(url, method="GET")
        with urllib.request.urlopen(req, timeout=10) as resp:
            return True, json.loads(resp.read().decode())
    except Exception as e:
        return False, str(e)


def main():
    args = sys.argv[1:]

    if "--help" in args or "-h" in args:
        print(__doc__)
        sys.exit(0)

    if "--list-voices" in args:
        # Query available voices from a test endpoint or hardcoded
        print("Available voices:")
        print("  - Microsoft David Desktop")
        print("  - Microsoft Zira Desktop")
        return

    message = "Test notification from Token-API"
    tts_only = "--tts-only" in args
    sound_only = "--sound-only" in args

    # Get custom message
    for arg in args:
        if not arg.startswith("--"):
            message = arg
            break

    if sound_only:
        print(f"Playing test sound...")
        ok, result = send_request("/api/notify/sound", {"sound": "chimes.wav"})
    elif tts_only:
        print(f"Sending TTS: {message}")
        ok, result = send_request("/api/notify/tts", {"text": message})
    else:
        print(f"Sending notification: {message}")
        ok, result = send_request("/api/notify", {
            "text": message,
            "sound": "chimes.wav"
        })

    if ok:
        print(f"OK: {result}")
    else:
        print(f"Error: {result}")
        sys.exit(1)


if __name__ == "__main__":
    main()
