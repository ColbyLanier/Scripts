#!/usr/bin/env python3
# timer-mode - Switch timer mode from the command line
# TAGS: token-api
# AUDIENCE: human, agent
"""Switch timer mode from the command line.

Usage:
    timer-mode break          # Enter break mode (manual override, consumes break balance)
    timer-mode pause          # Set productivity inactive (â†’ IDLE)
    timer-mode resume         # Exit manual override, set productivity active
    timer-mode work           # Alias for resume
    timer-mode sleep          # Enter sleeping (manual override, neutral rate)
    timer-mode silence        # Legacy alias for resume (v1 compat)
    timer-mode status         # Show current mode + break balance
"""

import sys
import json
import urllib.request

API_URL = "http://localhost:7777"

COMMANDS = {
    "break": ("POST", "/api/timer/break"),
    "pause": ("POST", "/api/timer/pause"),
    "resume": ("POST", "/api/timer/resume"),
    "work": ("POST", "/api/timer/resume"),
    "sleep": ("POST", "/api/timer/sleep"),
    "silence": ("POST", "/api/timer/resume"),  # v1 legacy alias
    "status": ("GET", "/api/timer"),
}


def color(text, code):
    return f"\033[{code}m{text}\033[0m"


def fmt_seconds(s):
    s = int(s)
    if s < 0:
        sign = "-"
        s = -s
    else:
        sign = ""
    h, m = divmod(s // 60, 60)
    if h:
        return f"{sign}{h}h {m:02d}m"
    return f"{sign}{m}m"


def api_call(method, path):
    try:
        req = urllib.request.Request(f"{API_URL}{path}", method=method)
        if method == "POST":
            req.add_header("Content-Type", "application/json")
            req.data = b""
        with urllib.request.urlopen(req, timeout=5) as resp:
            return resp.status, json.loads(resp.read().decode())
    except urllib.error.HTTPError as e:
        body = e.read().decode()
        try:
            detail = json.loads(body).get("detail", body)
        except Exception:
            detail = body
        return e.code, {"error": detail}
    except Exception as e:
        return 0, {"error": str(e)}


def main():
    args = sys.argv[1:]

    if not args or "--help" in args or "-h" in args:
        print(__doc__.strip())
        return

    cmd = args[0].lower()
    if cmd not in COMMANDS:
        print(f"Unknown command: {cmd}", file=sys.stderr)
        print(f"Valid: {', '.join(k for k in COMMANDS if k != 'silence')}", file=sys.stderr)
        sys.exit(1)

    method, path = COMMANDS[cmd]
    status, data = api_call(method, path)

    if cmd == "status":
        if status == 200:
            mode = data.get("current_mode", "?")
            break_s = data.get("accumulated_break_seconds", 0)
            manual = data.get("manual_mode_lock", False)
            lock_str = f"  lock={color('yes', '33')}" if manual else ""
            print(f"Mode: {color(mode, '32')}  Break: {fmt_seconds(break_s)}{lock_str}")
        else:
            print(color(f"Error: {data.get('error', 'unknown')}", "31"), file=sys.stderr)
            sys.exit(1)
        return

    if status == 200:
        changed = data.get("changed", False)
        new_mode = data.get("status", cmd)
        if changed:
            print(color(f"Switched to {new_mode}", "32"))
        else:
            print(f"Already in {new_mode} (no change)")

        if "break_available_seconds" in data:
            print(f"Break available: {fmt_seconds(data['break_available_seconds'])}")
    elif status == 400:
        print(color(f"Blocked: {data.get('error', 'unknown')}", "33"), file=sys.stderr)
        sys.exit(1)
    else:
        print(color(f"Error ({status}): {data.get('error', 'unknown')}", "31"), file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
