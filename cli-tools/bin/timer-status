#!/usr/bin/env python3
# timer-status - Quick timer status display
# TAGS: token-api
# AUDIENCE: human, agent
"""Quick timer status display.

Usage:
    timer-status              # One-line status
    timer-status --layers     # One-line status + layer breakdown
    timer-status --shifts     # One-line status + session mode distribution
    timer-status --watch      # Continuous monitoring (1s refresh)
    timer-status --json       # Raw JSON from API
"""

import sys
import json
import time
import urllib.request

API_URL = "http://localhost:7777"

# v2 effective modes (lowercase from API)
MODE_ICONS = {
    "working":      "\U0001f4bc",   # üíº
    "multitasking": "\u26a1",       # ‚ö°
    "idle":         "\u23f8",       # ‚è∏
    "distracted":   "\u26a0\ufe0f", # ‚ö†Ô∏è
    "break":        "\u2615",       # ‚òï
    "sleeping":     "\U0001f319",   # üåô
}


def get_timer():
    try:
        req = urllib.request.Request(f"{API_URL}/api/timer", method="GET")
        with urllib.request.urlopen(req, timeout=2) as resp:
            return json.loads(resp.read().decode())
    except Exception as e:
        return None


def get_shifts():
    try:
        req = urllib.request.Request(f"{API_URL}/api/timer/shifts", method="GET")
        with urllib.request.urlopen(req, timeout=3) as resp:
            return json.loads(resp.read().decode())
    except Exception:
        return None


def fmt_time(seconds):
    """Format seconds as HH:MM:SS or MM:SS."""
    if seconds <= 0:
        return "00:00"
    h = seconds // 3600
    m = (seconds % 3600) // 60
    s = seconds % 60
    if h > 0:
        return f"{h}:{m:02d}:{s:02d}"
    return f"{m:02d}:{s:02d}"


def fmt_seconds_hm(seconds):
    """Format seconds as Xh Ym."""
    h = int(seconds) // 3600
    m = (int(seconds) % 3600) // 60
    if h > 0:
        return f"{h}h {m:02d}m"
    return f"{m}m"


def fmt_ms_hm(ms):
    """Format milliseconds as Xh Ym."""
    h = ms // (1000 * 60 * 60)
    m = (ms % (1000 * 60 * 60)) // (1000 * 60)
    return f"{h}h {m:02d}m"


def color(text, code):
    """ANSI color wrapper."""
    return f"\033[{code}m{text}\033[0m"


def display(data, show_layers=False):
    mode = (data.get("current_mode") or "").lower()
    icon = MODE_ICONS.get(mode, "\u2753")  # ‚ùì fallback
    mode_name = mode.replace("_", " ").title() if mode else "?"

    break_s = data.get("accumulated_break_seconds", 0)
    break_str = fmt_time(break_s)
    work_str = fmt_ms_hm(data.get("total_work_time_ms", 0))

    # Color break time
    if break_s > 1800:
        break_colored = color(break_str, "32")  # green
    elif break_s > 300:
        break_colored = color(break_str, "33")  # yellow
    else:
        break_colored = color(break_str, "31")  # red

    # Layer context: desktop_mode or phone_app label
    activity_detail = ""
    desktop_mode = data.get("desktop_mode")
    phone_app = data.get("phone_app")
    if desktop_mode and desktop_mode not in ("silence", "working"):
        activity_detail = color(f"  [{desktop_mode}]", "36")
    elif phone_app:
        activity_detail = color(f"  [phone:{phone_app}]", "36")

    # Manual mode / lock indicator
    lock = ""
    manual = data.get("manual_mode")
    if manual:
        lock = color(f"  [{manual}]", "33")
    elif data.get("manual_mode_lock"):
        lock = color("  [locked]", "33")

    # Backlog indicator
    backlog = ""
    if data.get("is_in_backlog"):
        bl_s = round(data.get("break_backlog_ms", 0) / 1000)
        backlog = color(f"  Backlog: {fmt_time(bl_s)}", "31")

    # Work mode (clocked out / gym)
    wm = data.get("work_mode", "clocked_in")
    wm_str = ""
    if wm == "clocked_out":
        wm_str = color("  OFF", "90")
    elif wm == "gym":
        wm_str = color("  GYM", "35")

    print(f"{icon}  {mode_name}  Break: {break_colored}  Work: {work_str}{activity_detail}{lock}{backlog}{wm_str}")

    if show_layers:
        activity = data.get("activity", "?")
        prod_active = data.get("productivity_active", False)
        prod_str = color("active", "32") if prod_active else color("inactive", "90")
        manual_str = manual if manual else color("‚Äî", "90")
        dm_str = desktop_mode or color("‚Äî", "90")
        print(f"  Activity: {activity}  Desktop: {dm_str}  Productivity: {prod_str}  Manual: {manual_str}")


def display_shifts(shifts):
    """Print a compact session mode-distribution summary."""
    dist = shifts.get("mode_distribution", {})
    total_s = sum(dist.values()) or 1

    # Mode order: productive ‚Üí neutral ‚Üí negative
    mode_order = ["working", "multitasking", "idle", "break", "distracted", "sleeping"]
    mode_colors = {
        "working":      "32",  # green
        "multitasking": "33",  # yellow
        "idle":         "90",  # dim
        "break":        "36",  # cyan
        "distracted":   "31",  # red
        "sleeping":     "34",  # blue
    }

    parts = []
    for m in mode_order:
        s = dist.get(m, 0)
        if s == 0:
            continue
        pct = 100.0 * s / total_s
        icon = MODE_ICONS.get(m, "?")
        label = fmt_seconds_hm(s)
        col = mode_colors.get(m, "37")
        parts.append(f"{icon} {color(label, col)} ({pct:.0f}%)")

    print("  " + "  ".join(parts))

    # Trigger / enforcement row
    triggers = shifts.get("shifts_by_trigger", {})
    enforced = shifts.get("enforcement_count", 0)
    twitter = shifts.get("twitter_shifts", 0)
    total_shifts = shifts.get("total_shifts", 0)

    trig_parts = []
    for k, v in sorted(triggers.items(), key=lambda x: -x[1]):
        if v > 0:
            trig_parts.append(f"{k}:{v}")

    trig_str = "  ".join(trig_parts) if trig_parts else "‚Äî"
    enforced_str = color(str(enforced), "31") if enforced > 0 else "0"
    twitter_str = color(str(twitter), "31") if twitter > 20 else str(twitter)

    print(f"  {color(str(total_shifts) + ' shifts', '90')}  " +
          color(f"Enforced:{enforced}  ", "31" if enforced > 50 else "37") +
          color(f"Twitter:{twitter}  ", "31" if twitter > 20 else "37") +
          color(f"[{trig_str}]", "90"))


def main():
    args = sys.argv[1:]

    if "--help" in args or "-h" in args:
        print(__doc__.strip())
        return

    if "--json" in args:
        data = get_timer()
        if data:
            print(json.dumps(data, indent=2))
        else:
            print("Error: Could not reach Token-API", file=sys.stderr)
            sys.exit(1)
        return

    show_layers = "--layers" in args
    show_shifts = "--shifts" in args

    if "--watch" in args:
        try:
            while True:
                print("\033[2J\033[H", end="")  # clear screen
                data = get_timer()
                if data:
                    display(data, show_layers=show_layers)
                    if show_shifts:
                        shifts = get_shifts()
                        if shifts:
                            display_shifts(shifts)
                else:
                    print(color("Server unreachable", "31"))
                time.sleep(1)
        except KeyboardInterrupt:
            pass
        return

    data = get_timer()
    if data:
        display(data, show_layers=show_layers)
        if show_shifts:
            shifts = get_shifts()
            if shifts:
                display_shifts(shifts)
            else:
                print(color("  (shifts unavailable)", "90"), file=sys.stderr)
    else:
        print(color("Server unreachable", "31"), file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
