#!/usr/bin/env bash
# Save current break time, load a test value, and restore later.
# TAGS: token-api
# AUDIENCE: agent
#
# Usage:
#   timer-test 60       # Save real break time, set to 60 minutes
#   timer-test 30       # Already in test mode â€” set to 30 min (original preserved)
#   timer-test pop      # Restore saved break time, clean up

set -euo pipefail

API="http://localhost:7777"
SAVE_FILE="/tmp/timer-test-break-save"

die() { echo "$1" >&2; exit 1; }

get_break_seconds() {
    curl -sf "$API/api/timer" | python3 -c "import sys,json; print(json.load(sys.stdin)['accumulated_break_seconds'])"
}

set_break_seconds() {
    curl -sf -X POST "$API/api/timer/set-break?seconds=$1" >/dev/null
}

case "${1:-}" in
    -h|--help|"")
        echo "Usage: timer-test <minutes>   Set break time (saves real value first)"
        echo "       timer-test pop         Restore saved break time"
        exit 0
        ;;
    pop)
        [[ -f "$SAVE_FILE" ]] || exit 0
        saved=$(cat "$SAVE_FILE")
        set_break_seconds "$saved"
        rm -f "$SAVE_FILE"
        echo "Restored break time: $((saved / 60))m $((saved % 60))s"
        ;;
    *)
        input="$1"
        [[ "$input" =~ ^[0-9]+(\.[0-9]+)?$ ]] || die "Expected a number of minutes or 'pop'"

        # Save current break time only if not already in test mode
        if [[ ! -f "$SAVE_FILE" ]]; then
            get_break_seconds > "$SAVE_FILE"
            echo "Saved break time: $(cat "$SAVE_FILE")s"
        fi

        # x.0 special case: x minutes + 1 second (for testing breakpoint transitions)
        if [[ "$input" =~ ^([0-9]+)\.0$ ]]; then
            seconds=$(( ${BASH_REMATCH[1]} * 60 + 1 ))
        else
            seconds=$(python3 -c "import math; print(math.floor($input * 60))")
        fi
        set_break_seconds "$seconds"
        echo "Break time set to ${seconds}s (test mode)"
        ;;
esac
