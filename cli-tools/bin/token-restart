#!/usr/bin/env bash
# token-restart - Restart the Token-API server
#
# Usage:
#   token-restart              # Restart server via launchctl
#   token-restart --kill       # Just kill, don't restart
#   token-restart --watch      # Restart and monitor startup
#   token-restart --status     # Show current status only
#
# The server runs on port 7777 and is managed by launchd (ai.openclaw.tokenapi)

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

LABEL="ai.openclaw.tokenapi"
PLIST="$HOME/Library/LaunchAgents/${LABEL}.plist"

show_help() {
    cat << 'EOF'
token-restart - Restart the Token-API server

Usage:
    token-restart              Restart server (launchctl kickstart)
    token-restart --kill       Kill process (launchd auto-restarts)
    token-restart --watch      Restart and monitor startup logs
    token-restart --status     Show current server status only
    token-restart -h, --help   Show this help

Examples:
    token-restart              # Quick restart
    token-restart --watch      # Restart and tail logs
    token-restart --status     # Check if running

Notes:
    - Server runs on port 7777
    - Managed by launchd (ai.openclaw.tokenapi)
    - Logs: ~/.claude/token-api-stdout.log, token-api-stderr.log
EOF
}

check_health() {
    if curl -sf http://localhost:7777/health > /dev/null 2>&1; then
        echo -e "${GREEN}●${NC} Server is healthy"
        return 0
    else
        echo -e "${RED}●${NC} Server is not responding"
        return 1
    fi
}

get_status() {
    echo "=== Token-API Status ==="

    # Check launchd status
    if launchctl print gui/501/${LABEL} > /dev/null 2>&1; then
        echo -e "Launchd: ${GREEN}loaded${NC}"
    else
        echo -e "Launchd: ${RED}not loaded${NC}"
    fi

    # Check process
    local pid
    pid=$(pgrep -f 'uvicorn.*7777' 2>/dev/null || true)
    if [[ -n "$pid" ]]; then
        echo -e "Process: ${GREEN}running${NC} (PID: $pid)"
    else
        echo -e "Process: ${RED}not running${NC}"
    fi

    # Health check
    check_health
}

kill_server() {
    echo "Stopping Token-API..."

    if pkill -f 'uvicorn.*7777' 2>/dev/null; then
        echo "Killed uvicorn process"
    else
        echo "No process found"
    fi

    sleep 1

    if pgrep -f 'uvicorn.*7777' > /dev/null 2>&1; then
        echo -e "${YELLOW}Warning: Process still running, force killing...${NC}"
        pkill -9 -f 'uvicorn.*7777' 2>/dev/null || true
    fi

    echo -e "${GREEN}Server stopped${NC}"
    echo "Note: launchd will auto-restart unless you 'launchctl bootout gui/501/${LABEL}'"
}

restart_server() {
    echo "Restarting Token-API..."

    # Use launchctl kickstart -k to kill and restart in one step
    launchctl kickstart -k gui/501/${LABEL} 2>/dev/null || {
        # If not loaded, bootstrap it
        echo "Service not loaded, bootstrapping..."
        launchctl bootstrap gui/501 "$PLIST" 2>/dev/null || true
    }

    # Wait for startup
    local attempts=0
    local max_attempts=10

    while [[ $attempts -lt $max_attempts ]]; do
        sleep 1
        if curl -sf http://localhost:7777/health > /dev/null 2>&1; then
            echo -e "${GREEN}Server is up and healthy${NC}"
            return 0
        fi
        attempts=$((attempts + 1))
        echo "  Waiting... ($attempts/$max_attempts)"
    done

    echo -e "${RED}Server failed to start within ${max_attempts}s${NC}"
    echo "Check logs: tail ~/.claude/token-api-stderr.log"
    return 1
}

watch_logs() {
    echo "Tailing logs (Ctrl+C to stop)..."
    tail -f ~/.claude/token-api-stderr.log
}

# Parse arguments
ACTION="restart"

while [[ $# -gt 0 ]]; do
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
        --kill)
            ACTION="kill"
            shift
            ;;
        --watch)
            ACTION="watch"
            shift
            ;;
        --status)
            ACTION="status"
            shift
            ;;
        *)
            echo "Unknown option: $1" >&2
            echo "Use --help for usage" >&2
            exit 1
            ;;
    esac
done

# Execute action
case "$ACTION" in
    status)
        get_status
        ;;
    kill)
        kill_server
        ;;
    watch)
        restart_server
        watch_logs
        ;;
    restart)
        restart_server
        ;;
esac
