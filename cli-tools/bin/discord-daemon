#!/usr/bin/env bash
# discord-daemon - Manage the Discord CLI daemon
# TAGS: claw, discord
# AUDIENCE: human, agent
#
# Usage: discord-daemon <start|stop|restart|status|logs>
#
# The daemon maintains a persistent WebSocket connection to Discord
# and exposes a local HTTP API on localhost:7779.

set -euo pipefail

DAEMON_DIR="$HOME/.discord-cli"
NODE_DIR="$DAEMON_DIR/node"
PID_FILE="$DAEMON_DIR/daemon.pid"
LOG_DIR="$DAEMON_DIR/logs"
DAEMON_URL="http://127.0.0.1:7779"

die() { echo "Error: $*" >&2; exit 1; }

get_pid() {
  [[ -f "$PID_FILE" ]] && cat "$PID_FILE" || echo ""
}

is_running() {
  local pid
  pid=$(get_pid)
  [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null
}

cmd_start() {
  if is_running; then
    echo "Daemon already running (PID $(get_pid))"
    exit 0
  fi

  # Check node_modules
  if [[ ! -d "$NODE_DIR/node_modules" ]]; then
    echo "Installing dependencies..."
    pushd "$NODE_DIR" > /dev/null 2>&1
    /opt/homebrew/bin/npm install 2>&1
    popd > /dev/null 2>&1
  fi

  echo "Starting Discord daemon..."
  mkdir -p "$LOG_DIR"

  # Start daemon in background
  nohup /opt/homebrew/bin/node "$NODE_DIR/daemon.js" \
    >> "$LOG_DIR/daemon-$(date +%Y-%m-%d).log" 2>&1 &

  local new_pid=$!
  echo "$new_pid" > "$PID_FILE"

  # Wait a moment and verify it started
  sleep 2
  if kill -0 "$new_pid" 2>/dev/null; then
    echo "Daemon started (PID $new_pid)"
    # Quick health check
    sleep 1
    if curl -sf "$DAEMON_URL/status" >/dev/null 2>&1; then
      echo "Health check: OK"
    else
      echo "Health check: Waiting for Discord connection..."
    fi
  else
    echo "Daemon failed to start. Check logs:"
    echo "  tail -20 $LOG_DIR/daemon-$(date +%Y-%m-%d).log"
    rm -f "$PID_FILE"
    exit 1
  fi
}

cmd_stop() {
  local pid
  pid=$(get_pid)

  if [[ -z "$pid" ]]; then
    echo "Daemon not running (no PID file)"
    exit 0
  fi

  if kill -0 "$pid" 2>/dev/null; then
    echo "Stopping daemon (PID $pid)..."
    kill "$pid"

    # Wait for graceful shutdown
    local i=0
    while kill -0 "$pid" 2>/dev/null && [[ $i -lt 10 ]]; do
      sleep 0.5
      ((i++))
    done

    if kill -0 "$pid" 2>/dev/null; then
      echo "Force killing..."
      kill -9 "$pid" 2>/dev/null || true
    fi

    echo "Daemon stopped."
  else
    echo "Daemon not running (stale PID file)"
  fi

  rm -f "$PID_FILE"
}

cmd_restart() {
  cmd_stop
  sleep 1
  cmd_start
}

cmd_status() {
  local pid
  pid=$(get_pid)

  if [[ -z "$pid" ]] || ! kill -0 "$pid" 2>/dev/null; then
    echo "Daemon: stopped"
    [[ -n "$pid" ]] && echo "  (stale PID file: $pid)"
    exit 1
  fi

  echo "Daemon: running (PID $pid)"

  # Try health check
  if curl -sf "$DAEMON_URL/status" 2>/dev/null | jq -r '
    "  Connected: \(.connected)\n  User: \(.user // "unknown")\n  Ping: \(.ping)ms\n  Channels: \(.channels)"
  ' 2>/dev/null; then
    :
  else
    echo "  HTTP API not responding (may still be connecting)"
  fi
}

cmd_logs() {
  local log_file="$LOG_DIR/daemon-$(date +%Y-%m-%d).log"
  local lines="${1:-50}"

  if [[ ! -f "$log_file" ]]; then
    echo "No log file for today. Checking for most recent..."
    log_file=$(ls -t "$LOG_DIR"/daemon-*.log 2>/dev/null | head -1)
    [[ -z "$log_file" ]] && die "No log files found"
  fi

  if [[ "${1:-}" == "-f" || "${1:-}" == "--follow" ]]; then
    tail -f "$log_file"
  else
    tail -"$lines" "$log_file"
  fi
}

# --- Main ---

[[ $# -eq 0 ]] && {
  echo "Usage: discord-daemon <start|stop|restart|status|logs>"
  exit 1
}

case "$1" in
  start)   cmd_start ;;
  stop)    cmd_stop ;;
  restart) cmd_restart ;;
  status)  cmd_status ;;
  logs)    shift; cmd_logs "$@" ;;
  -h|--help) echo "Usage: discord-daemon <start|stop|restart|status|logs>"; exit 0 ;;
  *) die "Unknown command: $1" ;;
esac
