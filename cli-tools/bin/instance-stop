#!/usr/bin/env python3
"""Stop a Claude instance by name or ID.

Usage:
    instance-stop <name>               # Stop by name (fuzzy match)
    instance-stop --id <uuid>          # Stop by exact ID
    instance-stop --unstick <name>     # Nudge stuck instance (SIGWINCH, gentle)
    instance-stop --unstick=2 <name>   # Interrupt stuck instance (SIGINT, cancel op)
    instance-stop --unstick=3 <name>   # Kill deadlocked instance (SIGKILL, resumable)
    instance-stop --kill <name>        # Alias for --unstick=3
    instance-stop --diagnose <name>    # Show process diagnostics for instance
    instance-stop --list               # List active instances
    instance-stop -h, --help           # Show help

Examples:
    instance-stop auth-refactor        # Stop instance named 'auth-refactor'
    instance-stop "fix bug"            # Stop instance with 'fix bug' in name
    instance-stop --id abc123...       # Stop by exact UUID
    instance-stop --unstick auth-bug   # Nudge stuck instance (level 1, SIGWINCH)
    instance-stop --unstick=2 auth-bug # Interrupt stuck instance (level 2, SIGINT)
    instance-stop --unstick=3 auth-bug # Kill deadlocked instance (level 3, SIGKILL)
    instance-stop --kill auth-bug      # Same as --unstick=3
    instance-stop --diagnose auth-bug  # Show process state, wchan, children, etc.
"""

import sys
import json
import sqlite3
from pathlib import Path

DB_PATH = Path.home() / ".claude" / "agents.db"
API_URL = "http://localhost:7777"

def get_active_instances():
    """Get all active instances from the database."""
    if not DB_PATH.exists():
        return []

    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.execute(
        "SELECT id, tab_name, working_dir, registered_at FROM claude_instances WHERE status IN ('processing', 'idle') ORDER BY registered_at DESC"
    )
    instances = [dict(row) for row in cursor.fetchall()]
    conn.close()
    return instances

def find_instance_by_name(name: str, instances: list) -> list:
    """Find instances matching the given name (case-insensitive, partial match)."""
    name_lower = name.lower()
    matches = []

    for inst in instances:
        tab_name = inst.get("tab_name", "").lower()
        working_dir = inst.get("working_dir", "").lower()

        if name_lower in tab_name or name_lower in working_dir:
            matches.append(inst)

    return matches

def stop_instance(instance_id: str) -> bool:
    """Stop an instance via the API."""
    import urllib.request
    import urllib.error

    url = f"{API_URL}/api/instances/{instance_id}"
    req = urllib.request.Request(url, method="DELETE")

    try:
        with urllib.request.urlopen(req, timeout=5) as resp:
            return resp.status == 200
    except urllib.error.URLError as e:
        print(f"Error: Failed to connect to Token-API: {e}", file=sys.stderr)
        return False
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        return False

def kill_instance(instance_id: str) -> dict:
    """Kill a frozen instance via the API. Returns result dict."""
    import urllib.request
    import urllib.error

    url = f"{API_URL}/api/instances/{instance_id}/kill"
    req = urllib.request.Request(
        url, method="POST",
        headers={"Content-Type": "application/json"},
        data=b"{}"
    )

    try:
        with urllib.request.urlopen(req, timeout=20) as resp:
            return json.loads(resp.read())
    except urllib.error.HTTPError as e:
        try:
            body = json.loads(e.read())
            return {"status": "error", "detail": body.get("detail", str(e))}
        except Exception:
            return {"status": "error", "detail": str(e)}
    except urllib.error.URLError as e:
        return {"status": "error", "detail": f"Failed to connect to Token-API: {e}"}
    except Exception as e:
        return {"status": "error", "detail": str(e)}

def unstick_instance(instance_id: str, level: int = 1) -> dict:
    """Nudge a stuck instance. Level 1=SIGWINCH (gentle), Level 2=SIGINT (cancel op). Returns result dict."""
    import urllib.request
    import urllib.error

    url = f"{API_URL}/api/instances/{instance_id}/unstick?level={level}"
    req = urllib.request.Request(
        url, method="POST",
        headers={"Content-Type": "application/json"},
        data=b"{}"
    )

    try:
        with urllib.request.urlopen(req, timeout=10) as resp:
            return json.loads(resp.read())
    except urllib.error.HTTPError as e:
        try:
            body = json.loads(e.read())
            return {"status": "error", "detail": body.get("detail", str(e))}
        except Exception:
            return {"status": "error", "detail": str(e)}
    except urllib.error.URLError as e:
        return {"status": "error", "detail": f"Failed to connect to Token-API: {e}"}
    except Exception as e:
        return {"status": "error", "detail": str(e)}

def diagnose_instance(instance_id: str) -> dict:
    """Get detailed diagnostics for an instance. Returns result dict."""
    import urllib.request
    import urllib.error

    url = f"{API_URL}/api/instances/{instance_id}/diagnose"
    req = urllib.request.Request(url, method="GET")

    try:
        with urllib.request.urlopen(req, timeout=10) as resp:
            return json.loads(resp.read())
    except urllib.error.HTTPError as e:
        try:
            body = json.loads(e.read())
            return {"error": body.get("detail", str(e))}
        except Exception:
            return {"error": str(e)}
    except Exception as e:
        return {"error": str(e)}


def format_instance(inst: dict) -> str:
    """Format instance for display."""
    name = inst.get("tab_name", "Unknown")
    work_dir = inst.get("working_dir", "")
    inst_id = inst.get("id", "")[:8]

    if work_dir:
        # Shorten home path
        work_dir = work_dir.replace(str(Path.home()), "~")
        return f"  {name} ({work_dir}) [{inst_id}...]"
    return f"  {name} [{inst_id}...]"

def main():
    args = sys.argv[1:]

    if not args or "-h" in args or "--help" in args:
        print(__doc__)
        sys.exit(0)

    if "--list" in args:
        instances = get_active_instances()
        if not instances:
            print("No active instances")
        else:
            print(f"Active instances ({len(instances)}):")
            for inst in instances:
                print(format_instance(inst))
        sys.exit(0)

    # Parse flags
    instance_id = None
    name = None
    do_diagnose = "--diagnose" in args
    do_unstick = False
    unstick_level = 1

    # --kill is now an alias for --unstick=3
    if "--kill" in args:
        do_unstick = True
        unstick_level = 3

    # Check for --unstick or --unstick=N
    for arg in args:
        if arg == "--unstick":
            do_unstick = True
        elif arg.startswith("--unstick="):
            do_unstick = True
            try:
                unstick_level = int(arg.split("=")[1])
                if unstick_level not in (1, 2, 3):
                    print("Error: --unstick level must be 1, 2, or 3", file=sys.stderr)
                    sys.exit(1)
            except ValueError:
                print("Error: --unstick level must be 1, 2, or 3", file=sys.stderr)
                sys.exit(1)

    i = 0
    while i < len(args):
        if args[i] == "--id":
            if i + 1 >= len(args):
                print("Error: --id requires a value", file=sys.stderr)
                sys.exit(1)
            instance_id = args[i + 1]
            i += 2
        elif args[i] in ("--kill", "--diagnose") or args[i].startswith("--unstick"):
            i += 1
        else:
            name = args[i]
            i += 1

    instances = get_active_instances()

    if instance_id:
        # Find by exact ID (or prefix)
        matches = [i for i in instances if i["id"].startswith(instance_id)]
        if not matches:
            print(f"Error: No instance found with ID starting with '{instance_id}'", file=sys.stderr)
            sys.exit(1)
        if len(matches) > 1:
            print(f"Error: Multiple instances match ID prefix '{instance_id}':", file=sys.stderr)
            for inst in matches:
                print(format_instance(inst), file=sys.stderr)
            sys.exit(1)
        target = matches[0]
    elif name:
        # Find by name
        matches = find_instance_by_name(name, instances)
        if not matches:
            print(f"Error: No active instance matching '{name}'", file=sys.stderr)
            print("\nActive instances:")
            for inst in instances:
                print(format_instance(inst))
            sys.exit(1)
        if len(matches) > 1:
            print(f"Multiple instances match '{name}':", file=sys.stderr)
            for inst in matches:
                print(format_instance(inst), file=sys.stderr)
            print("\nUse --id <uuid> to specify exactly which one.", file=sys.stderr)
            sys.exit(1)
        target = matches[0]
    else:
        print("Error: Specify instance name or --id", file=sys.stderr)
        sys.exit(1)

    if do_diagnose:
        # Show process diagnostics
        print(f"Diagnosing: {target['tab_name']} [{target['id'][:8]}...]")
        result = diagnose_instance(target["id"])

        if "error" in result:
            print(f"Diagnose failed: {result['error']}", file=sys.stderr)
            sys.exit(1)

        print(f"\n  Instance ID:    {result.get('instance_id', '?')[:12]}...")
        print(f"  Working Dir:    {result.get('working_dir', '?')}")
        print(f"  DB Status:      {result.get('db_status', '?')}")
        print(f"  Last Activity:  {result.get('activity_age_human', result.get('last_activity', '?'))}")
        print(f"  Stored PID:     {result.get('stored_pid', 'None')}")
        print(f"  Discovered PID: {result.get('discovered_pid', 'None')}")

        if result.get("pid_mismatch"):
            print(f"  [!] PID MISMATCH - stored PID is stale")

        diag = result.get("stored_pid_diagnostics", {})
        if diag.get("exists"):
            print(f"\n  Process State:")
            print(f"    State:    {diag.get('state', '?')} ({diag.get('state_desc', '?')})")
            print(f"    Wchan:    {diag.get('wchan', '?')}")
            print(f"    Comm:     {diag.get('comm', '?')}")
            print(f"    PPID:     {diag.get('ppid', '?')}")

            children = diag.get("children", [])
            if children:
                print(f"    Children: {len(children)}")
                for child in children[:5]:  # Show max 5
                    print(f"      - PID {child['pid']}: {child['comm']}")
                if len(children) > 5:
                    print(f"      ... and {len(children) - 5} more")

            fds = diag.get("fds", {})
            if fds:
                print(f"    FDs:")
                print(f"      stdin:  {fds.get('0', '?')}")
                print(f"      stdout: {fds.get('1', '?')}")
                print(f"      stderr: {fds.get('2', '?')}")
        elif diag:
            print(f"\n  [!] Stored PID {result.get('stored_pid')} does not exist")

        all_claude = result.get("all_claude_processes", [])
        print(f"\n  All Claude Processes: {len(all_claude)}")
        for proc in all_claude[:10]:
            marker = " <--" if proc["pid"] == result.get("stored_pid") else ""
            marker = " <-- DISCOVERED" if proc["pid"] == result.get("discovered_pid") else marker
            print(f"    PID {proc['pid']}: {proc['cwd']}{marker}")

    elif do_unstick:
        # Unstick instance at specified level
        level_descs = {1: "Nudging (L1)", 2: "Interrupting (L2)", 3: "Killing (L3)"}
        level_desc = level_descs.get(unstick_level, f"Unstick L{unstick_level}")
        print(f"{level_desc}: {target['tab_name']} [{target['id'][:8]}...]")
        result = unstick_instance(target["id"], level=unstick_level)
        status = result.get("status", "error")
        sig = result.get("signal", "?")

        if unstick_level == 3:
            # Level 3 (SIGKILL) - process is dead, show resume info
            if status in ("nudged", "no_change"):
                working_dir = target.get("working_dir", "")
                instance_id = target.get("id", "")
                print(f"{sig}: process killed (PID {result.get('pid', '?')})")
                if working_dir:
                    print(f"\nTo resume: cd {working_dir} && claude --resume {instance_id}")
            elif status == "error":
                print(f"Kill failed: {result.get('detail', 'unknown error')}", file=sys.stderr)
                sys.exit(1)
            else:
                print(f"Unexpected result: {result}", file=sys.stderr)
                sys.exit(1)
        else:
            # Levels 1-2: show activity change and diagnostics
            if status == "nudged":
                print(f"{sig}: activity detected (PID {result.get('pid', '?')})")
                diag_before = result.get("diagnostics_before", {})
                diag_after = result.get("diagnostics_after", {})
                if diag_before or diag_after:
                    print(f"  Before: state={diag_before.get('state', '?')} wchan={diag_before.get('wchan', '?')}")
                    print(f"  After:  state={diag_after.get('state', '?')} wchan={diag_after.get('wchan', '?')}")
            elif status == "no_change":
                print(f"{sig}: no activity change (PID {result.get('pid', '?')})")
                diag_before = result.get("diagnostics_before", {})
                diag_after = result.get("diagnostics_after", {})
                if diag_before or diag_after:
                    print(f"  Before: state={diag_before.get('state', '?')} wchan={diag_before.get('wchan', '?')}")
                    print(f"  After:  state={diag_after.get('state', '?')} wchan={diag_after.get('wchan', '?')}")
                    children = diag_before.get("children", [])
                    if children:
                        print(f"  Children: {[c['comm'] for c in children]}")
                # Suggest escalation
                if unstick_level == 1:
                    print("\n  Try --unstick=2 (SIGINT) or --unstick=3 (SIGKILL) if still stuck")
                elif unstick_level == 2:
                    print("\n  Try --unstick=3 (SIGKILL) if deadlocked")
            elif status == "error":
                print(f"Unstick failed: {result.get('detail', 'unknown error')}", file=sys.stderr)
                sys.exit(1)
            else:
                print(f"Unexpected result: {result}", file=sys.stderr)
                sys.exit(1)
    else:
        # Normal stop
        print(f"Stopping: {target['tab_name']} [{target['id'][:8]}...]")
        if stop_instance(target["id"]):
            print("Instance stopped")
        else:
            print("Failed to stop instance", file=sys.stderr)
            sys.exit(1)

if __name__ == "__main__":
    main()
