#!/usr/bin/env python3
"""Stop a Claude instance by name or ID.

Usage:
    instance-stop <name>           # Stop by name (fuzzy match)
    instance-stop --id <uuid>      # Stop by exact ID
    instance-stop --kill <name>    # Kill frozen instance (SIGTERM/SIGKILL)
    instance-stop --list           # List active instances
    instance-stop -h, --help       # Show help

Examples:
    instance-stop auth-refactor    # Stop instance named 'auth-refactor'
    instance-stop "fix bug"        # Stop instance with 'fix bug' in name
    instance-stop --id abc123...   # Stop by exact UUID
    instance-stop --kill auth-bug  # Kill frozen instance process
"""

import sys
import json
import sqlite3
from pathlib import Path

DB_PATH = Path.home() / ".claude" / "agents.db"
API_URL = "http://localhost:7777"

def get_active_instances():
    """Get all active instances from the database."""
    if not DB_PATH.exists():
        return []

    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.execute(
        "SELECT id, tab_name, working_dir, registered_at FROM claude_instances WHERE status IN ('processing', 'idle') ORDER BY registered_at DESC"
    )
    instances = [dict(row) for row in cursor.fetchall()]
    conn.close()
    return instances

def find_instance_by_name(name: str, instances: list) -> list:
    """Find instances matching the given name (case-insensitive, partial match)."""
    name_lower = name.lower()
    matches = []

    for inst in instances:
        tab_name = inst.get("tab_name", "").lower()
        working_dir = inst.get("working_dir", "").lower()

        if name_lower in tab_name or name_lower in working_dir:
            matches.append(inst)

    return matches

def stop_instance(instance_id: str) -> bool:
    """Stop an instance via the API."""
    import urllib.request
    import urllib.error

    url = f"{API_URL}/api/instances/{instance_id}"
    req = urllib.request.Request(url, method="DELETE")

    try:
        with urllib.request.urlopen(req, timeout=5) as resp:
            return resp.status == 200
    except urllib.error.URLError as e:
        print(f"Error: Failed to connect to Token-API: {e}", file=sys.stderr)
        return False
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        return False

def kill_instance(instance_id: str) -> dict:
    """Kill a frozen instance via the API. Returns result dict."""
    import urllib.request
    import urllib.error

    url = f"{API_URL}/api/instances/{instance_id}/kill"
    req = urllib.request.Request(
        url, method="POST",
        headers={"Content-Type": "application/json"},
        data=b"{}"
    )

    try:
        with urllib.request.urlopen(req, timeout=15) as resp:
            return json.loads(resp.read())
    except urllib.error.HTTPError as e:
        try:
            body = json.loads(e.read())
            return {"status": "error", "detail": body.get("detail", str(e))}
        except Exception:
            return {"status": "error", "detail": str(e)}
    except urllib.error.URLError as e:
        return {"status": "error", "detail": f"Failed to connect to Token-API: {e}"}
    except Exception as e:
        return {"status": "error", "detail": str(e)}

def format_instance(inst: dict) -> str:
    """Format instance for display."""
    name = inst.get("tab_name", "Unknown")
    work_dir = inst.get("working_dir", "")
    inst_id = inst.get("id", "")[:8]

    if work_dir:
        # Shorten home path
        work_dir = work_dir.replace(str(Path.home()), "~")
        return f"  {name} ({work_dir}) [{inst_id}...]"
    return f"  {name} [{inst_id}...]"

def main():
    args = sys.argv[1:]

    if not args or "-h" in args or "--help" in args:
        print(__doc__)
        sys.exit(0)

    if "--list" in args:
        instances = get_active_instances()
        if not instances:
            print("No active instances")
        else:
            print(f"Active instances ({len(instances)}):")
            for inst in instances:
                print(format_instance(inst))
        sys.exit(0)

    # Parse flags
    instance_id = None
    name = None
    do_kill = "--kill" in args

    i = 0
    while i < len(args):
        if args[i] == "--id":
            if i + 1 >= len(args):
                print("Error: --id requires a value", file=sys.stderr)
                sys.exit(1)
            instance_id = args[i + 1]
            i += 2
        elif args[i] == "--kill":
            i += 1
        else:
            name = args[i]
            i += 1

    instances = get_active_instances()

    if instance_id:
        # Find by exact ID (or prefix)
        matches = [i for i in instances if i["id"].startswith(instance_id)]
        if not matches:
            print(f"Error: No instance found with ID starting with '{instance_id}'", file=sys.stderr)
            sys.exit(1)
        if len(matches) > 1:
            print(f"Error: Multiple instances match ID prefix '{instance_id}':", file=sys.stderr)
            for inst in matches:
                print(format_instance(inst), file=sys.stderr)
            sys.exit(1)
        target = matches[0]
    elif name:
        # Find by name
        matches = find_instance_by_name(name, instances)
        if not matches:
            print(f"Error: No active instance matching '{name}'", file=sys.stderr)
            print("\nActive instances:")
            for inst in instances:
                print(format_instance(inst))
            sys.exit(1)
        if len(matches) > 1:
            print(f"Multiple instances match '{name}':", file=sys.stderr)
            for inst in matches:
                print(format_instance(inst), file=sys.stderr)
            print("\nUse --id <uuid> to specify exactly which one.", file=sys.stderr)
            sys.exit(1)
        target = matches[0]
    else:
        print("Error: Specify instance name or --id", file=sys.stderr)
        sys.exit(1)

    if do_kill:
        # Kill frozen instance
        print(f"Killing: {target['tab_name']} [{target['id'][:8]}...]")
        result = kill_instance(target["id"])
        status = result.get("status", "error")
        if status == "killed":
            pid = result.get("pid", "?")
            sig = result.get("signal", "?")
            print(f"Instance killed (PID {pid}, {sig})")
        elif status == "already_dead":
            print(f"Instance already dead (PID {result.get('pid', '?')}), marked stopped")
        elif status == "error":
            print(f"Kill failed: {result.get('detail', 'unknown error')}", file=sys.stderr)
            sys.exit(1)
        else:
            print(f"Unexpected result: {result}", file=sys.stderr)
            sys.exit(1)
    else:
        # Normal stop
        print(f"Stopping: {target['tab_name']} [{target['id'][:8]}...]")
        if stop_instance(target["id"]):
            print("Instance stopped")
        else:
            print("Failed to stop instance", file=sys.stderr)
            sys.exit(1)

if __name__ == "__main__":
    main()
