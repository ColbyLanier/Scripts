#!/usr/bin/env python3
# work-mode - Show or set Token-API work mode
# TAGS: token-api
# AUDIENCE: human, agent
"""Show or set Token-API work mode.

Usage:
    work-mode                         # Show current work mode
    work-mode clocked_in              # Set work mode (normal enforcement)
    work-mode clocked_out             # Set work mode (no enforcement)
    work-mode gym                     # Set work mode (gym timer)
    work-mode --raw                   # Raw JSON output
    work-mode -h, --help              # Show this help

Modes:
    clocked_in    Normal enforcement ‚Äî video requires productivity
    clocked_out   No enforcement, all modes allowed
    gym           Gym timer mode, triggers gym timer in Obsidian

Source defaults to "manual" when set via this tool.
"""

import sys
import json
import platform
import urllib.request
import urllib.error

if platform.system() == "Darwin":
    API_URL = "http://localhost:7777"
else:
    API_URL = "http://100.95.109.23:7777"

RESET  = "\033[0m"
RED    = "\033[31m"
GREEN  = "\033[32m"
YELLOW = "\033[33m"
CYAN   = "\033[36m"
BOLD   = "\033[1m"
DIM    = "\033[2m"

VALID_MODES = ("clocked_in", "clocked_out", "gym")

MODE_DISPLAY = {
    "clocked_in":  (GREEN,  "clocked_in",  "üè¢"),
    "clocked_out": (YELLOW, "clocked_out", "üè†"),
    "gym":         (CYAN,   "gym",         "üèãÔ∏è"),
}


def request(method, path, body=None):
    url = f"{API_URL}{path}"
    data = json.dumps(body).encode() if body else None
    headers = {"Content-Type": "application/json"} if data else {}
    req = urllib.request.Request(url, data=data, headers=headers, method=method)
    try:
        with urllib.request.urlopen(req, timeout=5) as resp:
            return json.loads(resp.read().decode())
    except urllib.error.HTTPError as e:
        body_text = e.read().decode()
        print(f"\033[31mHTTP {e.code}: {body_text}\033[0m", file=sys.stderr)
        sys.exit(1)
    except urllib.error.URLError as e:
        print(f"\033[31mServer unreachable: {e.reason}\033[0m", file=sys.stderr)
        sys.exit(1)


def fmt_mode(mode):
    col, label, icon = MODE_DISPLAY.get(mode, (DIM, mode, "‚ùì"))
    return f"{icon}  {col}{BOLD}{label}{RESET}"


def fmt_time(ts):
    if not ts:
        return f"{DIM}(unchanged){RESET}"
    # ts is an ISO string; just show the time part
    try:
        t = ts.split("T")[1][:8] if "T" in ts else ts
        return f"{DIM}{t}{RESET}"
    except Exception:
        return ts


def show_status(data):
    mode        = data.get("work_mode", "unknown")
    changed_at  = data.get("work_mode_changed_at")
    timer_mode  = data.get("current_timer_mode", "?")

    print(f"  Work mode:   {fmt_mode(mode)}")
    print(f"  Changed at:  {fmt_time(changed_at)}")
    print(f"  Timer mode:  {DIM}{timer_mode}{RESET}")


def main():
    args = sys.argv[1:]

    if "--help" in args or "-h" in args:
        print(__doc__.strip())
        return

    raw = "--raw" in args
    args = [a for a in args if a != "--raw"]

    if not args:
        # Show current mode
        data = request("GET", "/api/work-mode")
        if raw:
            print(json.dumps(data, indent=2))
        else:
            show_status(data)
        return

    mode = args[0].lower()
    if mode not in VALID_MODES:
        print(f"{RED}Unknown mode: {mode!r}{RESET}", file=sys.stderr)
        print(f"Valid modes: {', '.join(VALID_MODES)}", file=sys.stderr)
        sys.exit(1)

    data = request("POST", "/api/work-mode", {"mode": mode, "source": "manual"})
    if raw:
        print(json.dumps(data, indent=2))
    else:
        # Show updated state
        updated = request("GET", "/api/work-mode")
        show_status(updated)
        print(f"\n  {GREEN}Set to {BOLD}{mode}{RESET}")


if __name__ == "__main__":
    main()
