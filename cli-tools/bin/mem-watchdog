#!/usr/bin/env bash
# Memory Watchdog - monitors system memory and spawns claude to investigate leaks
#
# Usage: mem-watchdog [options]
#   mem-watchdog              # Single check (for use with cron/systemd timer)
#   mem-watchdog --daemon     # Run continuously in background
#   mem-watchdog --status     # Show current memory state and recent alerts
#   mem-watchdog --test       # Simulate a critical alert (dry run)
#
# Environment:
#   MEM_WARN_PCT=70         # Warning threshold (log + snapshot)
#   MEM_CRIT_PCT=85         # Critical threshold (snapshot + spawn claude)
#   MEM_CHECK_INTERVAL=60   # Seconds between checks in daemon mode
#   MEM_WATCHDOG_LOG        # Log file path override
#   MEM_COOLDOWN=900        # Seconds between claude spawns (default 15min)

set -euo pipefail

# --- Configuration ---
WARN_PCT="${MEM_WARN_PCT:-70}"
CRIT_PCT="${MEM_CRIT_PCT:-85}"
CHECK_INTERVAL="${MEM_CHECK_INTERVAL:-60}"
COOLDOWN="${MEM_COOLDOWN:-900}"
LOG_DIR="${HOME}/.local/share/mem-watchdog"
LOG_FILE="${MEM_WATCHDOG_LOG:-${LOG_DIR}/watchdog.log}"
SNAPSHOT_DIR="${LOG_DIR}/snapshots"
LOCK_FILE="${LOG_DIR}/claude-spawned.lock"

mkdir -p "$LOG_DIR" "$SNAPSHOT_DIR"

# --- Helpers ---
log() {
    local level="$1"; shift
    echo "$(date -Iseconds) [$level] $*" | tee -a "$LOG_FILE"
}

get_memory_pct() {
    # Works on both Linux and macOS
    if [[ "$(uname)" == "Darwin" ]]; then
        # macOS: use vm_stat
        local page_size
        page_size=$(sysctl -n hw.pagesize)
        local pages_free pages_active pages_inactive pages_speculative pages_wired total_pages
        local vm
        vm=$(vm_stat)
        pages_free=$(echo "$vm" | awk '/Pages free/ {gsub(/\./,"",$3); print $3}')
        pages_active=$(echo "$vm" | awk '/Pages active/ {gsub(/\./,"",$3); print $3}')
        pages_inactive=$(echo "$vm" | awk '/Pages inactive/ {gsub(/\./,"",$3); print $3}')
        pages_speculative=$(echo "$vm" | awk '/Pages speculative/ {gsub(/\./,"",$3); print $3}')
        pages_wired=$(echo "$vm" | awk '/Pages wired/ {gsub(/\./,"",$3); print $3}')
        local total_mem
        total_mem=$(sysctl -n hw.memsize)
        total_pages=$((total_mem / page_size))
        local used_pages=$((pages_active + pages_wired + pages_speculative))
        echo $((used_pages * 100 / total_pages))
    else
        # Linux: use /proc/meminfo (most accurate)
        awk '/MemTotal/{t=$2} /MemAvailable/{a=$2} END{printf "%d", (t-a)*100/t}' /proc/meminfo
    fi
}

get_memory_human() {
    if [[ "$(uname)" == "Darwin" ]]; then
        local total used_pct
        total=$(sysctl -n hw.memsize)
        used_pct=$(get_memory_pct)
        local total_gb=$(echo "scale=1; $total / 1073741824" | bc)
        local used_gb=$(echo "scale=1; $total * $used_pct / 100 / 1073741824" | bc)
        echo "${used_gb}G / ${total_gb}G (${used_pct}%)"
    else
        awk '/MemTotal/{t=$2} /MemAvailable/{a=$2} END{
            used=(t-a)/1048576; total=t/1048576; pct=(t-a)*100/t;
            printf "%.1fG / %.1fG (%d%%)", used, total, pct
        }' /proc/meminfo
    fi
}

capture_snapshot() {
    local reason="$1"
    local ts
    ts=$(date +%Y%m%d-%H%M%S)
    local snap_file="${SNAPSHOT_DIR}/${ts}-${reason}.txt"

    {
        echo "=== Memory Watchdog Snapshot ==="
        echo "Time: $(date -Iseconds)"
        echo "Reason: $reason"
        echo "Memory: $(get_memory_human)"
        echo ""
        echo "=== Top 20 Processes by Memory ==="
        ps aux --sort=-%mem 2>/dev/null | head -21 || ps aux -m 2>/dev/null | head -21
        echo ""
        echo "=== Memory Info ==="
        if [[ "$(uname)" == "Darwin" ]]; then
            vm_stat
        else
            cat /proc/meminfo | head -20
        fi
        echo ""
        echo "=== Swap ==="
        if [[ "$(uname)" == "Darwin" ]]; then
            sysctl vm.swapusage 2>/dev/null || true
        else
            swapon --show 2>/dev/null || true
        fi
    } > "$snap_file" 2>&1

    echo "$snap_file"
}

can_spawn_claude() {
    # Respect cooldown — don't spam claude instances
    if [[ -f "$LOCK_FILE" ]]; then
        local last_spawn
        last_spawn=$(cat "$LOCK_FILE")
        local now
        now=$(date +%s)
        local elapsed=$((now - last_spawn))
        if [[ $elapsed -lt $COOLDOWN ]]; then
            local remaining=$((COOLDOWN - elapsed))
            log "INFO" "Claude cooldown active (${remaining}s remaining), skipping spawn"
            return 1
        fi
    fi
    return 0
}

spawn_claude() {
    local snapshot_file="$1"

    # Record spawn time for cooldown
    date +%s > "$LOCK_FILE"

    local prompt
    prompt="$(cat <<EOF
URGENT: Memory watchdog triggered on $(hostname). The system is at critical memory usage
and processes may be killed by the OOM killer soon.

Here is the memory snapshot:

$(cat "$snapshot_file")

Please:
1. Identify which process(es) are consuming the most memory
2. Determine if this looks like a memory leak (growing over time) or expected usage
3. If a runaway process is identified, suggest whether it's safe to kill it
4. Check dmesg for any recent OOM events: run \`dmesg | grep -i oom | tail -20\`
5. Log your findings to ${LOG_DIR}/investigation-\$(date +%Y%m%d-%H%M%S).md

Do NOT kill any processes without clear justification. Be conservative.
EOF
)"

    log "CRIT" "Spawning claude instance to investigate memory pressure"

    # Run claude in background, non-interactive
    nohup claude -p "$prompt" > "${LOG_DIR}/claude-$(date +%Y%m%d-%H%M%S).log" 2>&1 &
    local pid=$!
    log "INFO" "Claude investigation started (PID: $pid)"
}

# --- Commands ---
cmd_check() {
    local force_level="${1:-}"
    local mem_pct

    if [[ "$force_level" == "test-critical" ]]; then
        mem_pct=90
        log "TEST" "Simulating critical memory (${mem_pct}%)"
    else
        mem_pct=$(get_memory_pct)
    fi

    if [[ $mem_pct -ge $CRIT_PCT ]]; then
        log "CRIT" "Memory at ${mem_pct}% (threshold: ${CRIT_PCT}%) — $(get_memory_human)"
        local snap
        snap=$(capture_snapshot "critical")
        log "CRIT" "Snapshot saved: $snap"

        if can_spawn_claude; then
            if [[ "$force_level" == "test-critical" ]]; then
                log "TEST" "Would spawn claude (dry run). Snapshot: $snap"
            else
                spawn_claude "$snap"
            fi
        fi
    elif [[ $mem_pct -ge $WARN_PCT ]]; then
        log "WARN" "Memory at ${mem_pct}% (threshold: ${WARN_PCT}%) — $(get_memory_human)"
        local snap
        snap=$(capture_snapshot "warning")
        log "WARN" "Snapshot saved: $snap"
    else
        # Only log to file, not stdout (quiet when healthy)
        echo "$(date -Iseconds) [OK] Memory at ${mem_pct}% — $(get_memory_human)" >> "$LOG_FILE"
    fi
}

cmd_daemon() {
    log "INFO" "Starting mem-watchdog daemon (warn=${WARN_PCT}%, crit=${CRIT_PCT}%, interval=${CHECK_INTERVAL}s)"
    while true; do
        cmd_check
        sleep "$CHECK_INTERVAL"
    done
}

cmd_status() {
    echo "=== Memory Watchdog Status ==="
    echo "Current: $(get_memory_human)"
    echo "Thresholds: warn=${WARN_PCT}% crit=${CRIT_PCT}%"
    echo "Log: $LOG_FILE"
    echo ""

    if [[ -f "$LOCK_FILE" ]]; then
        local last
        last=$(cat "$LOCK_FILE")
        local now
        now=$(date +%s)
        local elapsed=$((now - last))
        echo "Last claude spawn: ${elapsed}s ago"
    else
        echo "No claude spawns recorded"
    fi

    echo ""
    echo "=== Recent Alerts ==="
    grep -E "\[(WARN|CRIT)\]" "$LOG_FILE" 2>/dev/null | tail -10 || echo "No alerts"

    echo ""
    echo "=== Recent Snapshots ==="
    ls -lt "$SNAPSHOT_DIR"/*.txt 2>/dev/null | head -5 || echo "No snapshots"
}

# --- Main ---
case "${1:-}" in
    --help|-h)
        head -12 "$0" | tail -11
        ;;
    --daemon)
        cmd_daemon
        ;;
    --status)
        cmd_status
        ;;
    --test)
        cmd_check "test-critical"
        ;;
    *)
        cmd_check
        ;;
esac
