#!/bin/bash
# token-tasks - Query and manage Token API scheduled tasks
# Usage: token-tasks [history <task_id>|trigger <task_id>|status]

API="http://localhost:7777"

case "${1:-list}" in
  list|"")
    echo "=== Token API Scheduled Tasks ==="
    curl -s "$API/api/tasks" | jq -r '.[] | "[\(.enabled | if . then "OK" else "DIS" end)] \(.id)\n    Schedule: \(.schedule)\n    Last: \(.last_run.status) (\(.last_run.duration_ms)ms)\n    Next: \(.next_run)\n"'
    ;;
  history)
    if [[ -z "$2" ]]; then
      echo "Usage: token-tasks history <task_id>"
      echo "Example: token-tasks history checkin_morning_start"
      exit 1
    fi
    echo "=== Task History: $2 ==="
    curl -s "$API/api/tasks/$2/history" | jq -r '.[] | "[\(.status)] \(.started_at)\n    Duration: \(.duration_ms)ms\n    Result: \(.result | tojson)\n"'
    ;;
  trigger)
    if [[ -z "$2" ]]; then
      echo "Usage: token-tasks trigger <task_id>"
      echo "Example: token-tasks trigger checkin_morning_start"
      exit 1
    fi
    echo "=== Triggering: $2 ==="
    curl -s -X POST "$API/api/tasks/$2/trigger" | jq '.'
    ;;
  status)
    echo "=== Check-in Status ==="
    curl -s "$API/api/checkin/status" | jq '.'
    ;;
  *)
    echo "Usage: token-tasks [list|history <task_id>|trigger <task_id>|status]"
    echo ""
    echo "Commands:"
    echo "  token-tasks              - List all scheduled tasks"
    echo "  token-tasks history <id> - Show run history for a task"
    echo "  token-tasks trigger <id> - Manually trigger a task"
    echo "  token-tasks status       - Show check-in system status"
    exit 1
    ;;
esac
