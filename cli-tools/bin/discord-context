#!/usr/bin/env bash
# discord-context - Dump recent Discord channel messages to context/discord-recent.md
# TAGS: claw, discord, context
# AUDIENCE: human, agent
#
# Usage: discord-context [--limit N] [--channels "id1 id2 id3"]
#
# Default channels pulled from MEMORY (key channels for session continuity):
#   genal (1472043387535495323), questions (1472316252805664986)
#   + first TokenClaw guild channels

set -euo pipefail

WORKSPACE="$HOME/.openclaw/workspace"
# Must be named AGENTS.md so bootstrap-extra-files hook loads it (only recognizes AGENTS.md/TOOLS.md)
OUTPUT="$WORKSPACE/context/discord/AGENTS.md"
LIMIT=25

# Key channel IDs to pull (TokenClaw guild: 1472713270337994793)
# Only channels in the allowlist and most relevant for session continuity
CHANNELS=(
  "1472713270916944020"   # #general
  "1472722308199219352"   # #claw-chat
  "1473154087490158656"   # #tasks
  "1473154111301091469"   # #approvals
  "1473154160202612831"   # #alerts
  "1473154180200927264"   # #meta
  "1473154201331699874"   # #research
  "1473184628155088918"   # #operations
)

# Parse args
while [[ $# -gt 0 ]]; do
  case "$1" in
    --limit) LIMIT="$2"; shift 2 ;;
    --channels) IFS=' ' read -r -a CHANNELS <<< "$2"; shift 2 ;;
    --output) OUTPUT="$2"; shift 2 ;;
    *) shift ;;
  esac
done

mkdir -p "$(dirname "$OUTPUT")"

{
  echo "# Discord Recent Context"
  echo "_Generated: $(date '+%Y-%m-%d %H:%M:%S')_"
  echo "_Limit: last $LIMIT messages per channel_"
  echo ""
} > "$OUTPUT"

for CHANNEL_ID in "${CHANNELS[@]}"; do
  echo "Pulling channel $CHANNEL_ID (limit $LIMIT)..." >&2

  MSGS=$(openclaw message read \
    --channel discord \
    --target "channel:$CHANNEL_ID" \
    --limit "$LIMIT" \
    --json 2>/dev/null) || {
    echo "  [WARN] Failed to read channel $CHANNEL_ID" >&2
    continue
  }

  # Extract channel name and messages from payload structure
  CHANNEL_NAME=$(echo "$MSGS" | jq -r '.payload.messages[0].channel_id // "unknown"' 2>/dev/null || echo "unknown")

  {
    echo "## Channel $CHANNEL_ID"
    echo ""
    echo "$MSGS" | jq -r '.payload.messages[] | "**[\(.timestampUtc[0:16])] \(.author.username // "unknown")**: \(.content)"' 2>/dev/null \
      | head -"$LIMIT" \
      || echo "_No messages or parse error_"
    echo ""
  } >> "$OUTPUT"
done

echo "discord-context: wrote $OUTPUT" >&2
echo "$OUTPUT"
