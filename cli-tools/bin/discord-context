#!/usr/bin/env bash
# discord-context - Dump recent Discord channel messages to context file
# TAGS: claw, discord, context
# AUDIENCE: human, agent
#
# DEPRECATED: This tool now wraps `discord read`. Use `discord read` directly.
#
# Usage: discord-context [--limit N] [--channels "name1 name2"] [--output PATH]

set -euo pipefail

WORKSPACE="$HOME/.openclaw/workspace"
OUTPUT="$WORKSPACE/context/discord/AGENTS.md"
LIMIT=25
CHANNELS=(general claw-chat tasks approvals alerts meta research operations)

# Parse args
while [[ $# -gt 0 ]]; do
  case "$1" in
    --limit) LIMIT="$2"; shift 2 ;;
    --channels) IFS=' ' read -r -a CHANNELS <<< "$2"; shift 2 ;;
    --output) OUTPUT="$2"; shift 2 ;;
    *) shift ;;
  esac
done

mkdir -p "$(dirname "$OUTPUT")"

# Check if new daemon is running; fall back to old openclaw method
USE_NEW=false
if curl -sf "http://127.0.0.1:7779/status" >/dev/null 2>&1; then
  USE_NEW=true
fi

{
  echo "# Discord Recent Context"
  echo "_Generated: $(date '+%Y-%m-%d %H:%M:%S')_"
  echo "_Limit: last $LIMIT messages per channel_"
  echo ""
} > "$OUTPUT"

for CHANNEL in "${CHANNELS[@]}"; do
  echo "Pulling $CHANNEL (limit $LIMIT)..." >&2

  if [[ "$USE_NEW" == true ]]; then
    # Use new discord CLI
    MSGS=$(discord read "$CHANNEL" --limit "$LIMIT" 2>/dev/null) || {
      echo "  [WARN] Failed to read channel $CHANNEL" >&2
      continue
    }
    {
      echo "## #$CHANNEL"
      echo ""
      echo "$MSGS"
      echo ""
    } >> "$OUTPUT"
  else
    # Legacy: fall back to openclaw
    if ! command -v openclaw &>/dev/null; then
      echo "  [WARN] Neither discord daemon nor openclaw available" >&2
      continue
    fi

    # Resolve channel name to ID for openclaw
    case "$CHANNEL" in
      general)       CID="1472713270916944020" ;;
      claw-chat)     CID="1472722308199219352" ;;
      tasks)         CID="1473154087490158656" ;;
      approvals)     CID="1473154111301091469" ;;
      alerts)        CID="1473154160202612831" ;;
      meta)          CID="1473154180200927264" ;;
      research)      CID="1473154201331699874" ;;
      operations)    CID="1473184628155088918" ;;
      interrogative) CID="1474963429902258176" ;;
      *) CID="$CHANNEL" ;;
    esac

    RAW=$(openclaw message read --channel discord --target "channel:$CID" --limit "$LIMIT" --json 2>/dev/null) || {
      echo "  [WARN] Failed to read channel $CHANNEL" >&2
      continue
    }
    {
      echo "## #$CHANNEL"
      echo ""
      echo "$RAW" | jq -r '.payload.messages[] | "**[\(.timestampUtc[0:16])] \(.author.username // "unknown")**: \(.content)"' 2>/dev/null \
        | head -"$LIMIT" \
        || echo "_No messages or parse error_"
      echo ""
    } >> "$OUTPUT"
  fi
done

echo "discord-context: wrote $OUTPUT" >&2
echo "$OUTPUT"
