#!/bin/bash
# tasker-push - Push scripts to phone's ~/.termux/tasker/ via SSH
# TAGS: mobile
# AUDIENCE: human, agent
#
# Usage:
#   tasker-push <script>              # Push single script
#   tasker-push <script> ...          # Push multiple scripts
#   tasker-push --list                # List scripts on phone
#   tasker-push --all <dir>           # Push all scripts from a directory

set -e

SSH_HOST="phone"
REMOTE_DEST=".termux/tasker"

usage() {
    cat << 'EOF'
tasker-push - Push scripts to phone's ~/.termux/tasker/ via SSH

Usage:
    tasker-push <script>              # Push single script
    tasker-push <script> ...          # Push multiple scripts
    tasker-push --list                # List scripts on phone
    tasker-push --all <dir>           # Push all scripts from a directory

Examples:
    tasker-push hello.sh
    tasker-push scripts/*.sh
    tasker-push --all ~/Scripts/mobile/tasker-scripts/
    tasker-push --list

Scripts are pushed to ~/.termux/tasker/ on the phone and made executable.
Termux:Tasker plugin (MacroDroid/Tasker) can then invoke them.

Note: Requires SSH access to Termux on the phone via Tailscale.
EOF
    exit 1
}

check_connection() {
    if ! ssh -o ConnectTimeout=5 -o BatchMode=yes "$SSH_HOST" "echo ok" &>/dev/null; then
        echo "Error: Cannot connect to phone" >&2
        echo "Make sure Termux sshd is running and Tailscale is connected." >&2
        exit 1
    fi
}

list_scripts() {
    check_connection
    echo "Scripts on phone (~/$REMOTE_DEST/):"
    echo ""
    ssh "$SSH_HOST" "ls -la ~/$REMOTE_DEST/ 2>/dev/null" | tail -n +2 || echo "  (none)"
}

push_file() {
    local source="$1"
    local filename
    filename=$(basename "$source")

    if [[ ! -f "$source" ]]; then
        echo "Error: File not found: $source" >&2
        return 1
    fi

    scp -q "$source" "$SSH_HOST:~/$REMOTE_DEST/$filename"
    ssh "$SSH_HOST" "chmod +x ~/$REMOTE_DEST/$filename"
    echo "  $filename -> ~/$REMOTE_DEST/$filename"
}

# Check args
if [[ $# -lt 1 ]]; then
    usage
fi

case "$1" in
    --list|-l)
        list_scripts
        exit 0
        ;;
    --all|-a)
        if [[ $# -lt 2 ]]; then
            echo "Error: --all requires a directory argument" >&2
            exit 1
        fi
        DIR="$2"
        if [[ ! -d "$DIR" ]]; then
            echo "Error: Not a directory: $DIR" >&2
            exit 1
        fi
        FILES=("$DIR"/*)
        if [[ ${#FILES[@]} -eq 0 ]]; then
            echo "No files found in $DIR" >&2
            exit 1
        fi
        check_connection
        ssh "$SSH_HOST" "mkdir -p ~/$REMOTE_DEST"
        echo "Pushing all scripts from $DIR:"
        for f in "${FILES[@]}"; do
            [[ -f "$f" ]] && push_file "$f"
        done
        echo ""
        echo "Done! ${#FILES[@]} script(s) pushed."
        ;;
    --help|-h)
        usage
        ;;
    *)
        check_connection
        ssh "$SSH_HOST" "mkdir -p ~/$REMOTE_DEST"
        echo "Pushing to phone:"
        for f in "$@"; do
            push_file "$f"
        done
        echo ""
        echo "Done! Scripts available to Termux:Tasker plugin."
        ;;
esac
