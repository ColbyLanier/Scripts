#!/bin/bash
# ssh-connect - Standardized SSH with auto-close redirect
# TAGS: ssh, network
# AUDIENCE: human
# Usage: ssh-connect <mac|wsl|phone> [--proxy] [command...]
#
# When in an SSH session, instead of nesting (origin→A→target), this:
#   1. Writes redirect file on origin via reverse SSH
#   2. Exits current session (returns to origin)
#   3. Origin's wrapper loop picks up redirect and connects directly
#
# Use --proxy to skip redirect and nest normally.

set -e

if [[ -z "$1" ]]; then
    echo "Usage: ssh-connect <mac|wsl|phone> [--proxy] [command...]"
    exit 1
fi

TARGET="$1"; shift

PROXY=false
if [[ "$1" == "--proxy" ]]; then
    PROXY=true
    shift
fi

# Map target names to SSH host aliases (from ~/.ssh/config)
declare -A TARGET_HOST=(
    [mac]=mini
    [wsl]=wsl
    [phone]=phone
)

# Map Tailscale IPs to host aliases (for reverse SSH to origin)
declare -A IP_HOST=(
    [100.95.109.23]=mini
    [100.69.198.87]=desktop
    [100.66.10.74]=wsl
    [100.102.92.24]=phone
)

HOST="${TARGET_HOST[$TARGET]}"
if [[ -z "$HOST" ]]; then
    echo "Unknown target: $TARGET (expected mac, wsl, or phone)"
    exit 1
fi

# --- Redirect-on-exit: if in SSH session and not --proxy ---
if [[ -n "$SSH_CONNECTION" ]] && ! $PROXY; then
    origin_ip="${SSH_CLIENT%% *}"
    origin_host="${IP_HOST[$origin_ip]}"
    if [[ -n "$origin_host" ]]; then
        echo "Redirecting: closing this session → connecting to $TARGET from origin..."
        ssh -o ConnectTimeout=3 -o BatchMode=yes "$origin_host" \
            "echo $TARGET > /tmp/.ssh-next" 2>/dev/null
        exit 0
    fi
    # Fallback: if reverse SSH fails, replace session directly
    echo "Redirect failed, replacing session..."
    exec ssh "$HOST" "$@"
fi

# --- Direct connection (not in SSH session) ---
# Wrapper loop: after SSH exits, check for redirect file
while true; do
    if [[ $# -gt 0 ]]; then
        ssh "$HOST" -t "$*"
        break  # No redirect loop for command mode
    else
        ssh "$HOST"
    fi

    # Check for redirect from a nested session
    if [[ -f /tmp/.ssh-next ]]; then
        next=$(cat /tmp/.ssh-next)
        rm -f /tmp/.ssh-next
        HOST="${TARGET_HOST[$next]}"
        TARGET="$next"
        if [[ -z "$HOST" ]]; then
            echo "Invalid redirect target: $next"
            break
        fi
        echo "Redirecting to $TARGET..."
    else
        break
    fi
done
