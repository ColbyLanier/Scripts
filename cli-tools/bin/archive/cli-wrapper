#!/usr/bin/env bash
# Centralized CLI wrapper with automatic venv management
# Works in non-interactive shells (AI agents)

set -euo pipefail

CLI_TOOLS_DIR="${CLI_TOOLS_DIR:-$HOME/Scripts/cli-tools}"
VENV_DIR="$CLI_TOOLS_DIR/.venv"
PYTHON="${PYTHON:-python3}"
CALLER_DIR="$(pwd)"

# Ensure CLI tools directory exists
if [ ! -d "$CLI_TOOLS_DIR" ]; then
    echo "Error: CLI tools directory not found: $CLI_TOOLS_DIR" >&2
    exit 1
fi

# Check if uv is installed
if ! command -v uv >/dev/null 2>&1; then
    echo "Error: uv is not installed. Install it with: curl -LsSf https://astral.sh/uv/install.sh | sh" >&2
    exit 1
fi

# Function to ensure venv exists and is up to date
ensure_venv() {
    local needs_sync=false
    
    # Check if venv exists
    if [ ! -d "$VENV_DIR" ] || [ ! -f "$VENV_DIR/bin/python" ]; then
        echo "Creating virtual environment..." >&2
        (
            cd "$CLI_TOOLS_DIR"
            uv venv "$VENV_DIR" --python "$PYTHON"
        )
        needs_sync=true
    fi
    
    # Check if dependencies need updating
    # Compare pyproject.toml modification time with .last-sync
    if [ "$needs_sync" = true ] || \
       [ ! -f "$VENV_DIR/.last-sync" ] || \
       [ "$CLI_TOOLS_DIR/pyproject.toml" -nt "$VENV_DIR/.last-sync" ]; then
        echo "Installing/updating dependencies..." >&2
        (
            cd "$CLI_TOOLS_DIR"
            uv sync --python "$PYTHON" --no-dev
        )
        touch "$VENV_DIR/.last-sync"
    fi
}

# Function to run command in venv
run_in_venv() {
    local module="$1"
    shift
    
    ensure_venv

    if [ -n "${PYTHONPATH:-}" ]; then
        export PYTHONPATH="$CLI_TOOLS_DIR/src:$PYTHONPATH"
    else
        export PYTHONPATH="$CLI_TOOLS_DIR/src"
    fi
    export CLI_TOOLS_CALLER_DIR="$CALLER_DIR"
    (
        cd "$CALLER_DIR"
        "$VENV_DIR/bin/python" -m "$module" "$@"
    )
}

# Main execution
AVAILABLE_COMMANDS="subagent, time-convert, google-chat-message, db-query, cloud-logs, followup"

if [ $# -eq 0 ]; then
    echo "Usage: $0 <command> [args...]" >&2
    echo "Available commands: $AVAILABLE_COMMANDS" >&2
    exit 1
fi

COMMAND="$1"
shift

case "$COMMAND" in
    subagent)
        run_in_venv cli_tools.subagents.main "$@"
        ;;
    time-convert)
        run_in_venv cli_tools.timezone.cli "$@"
        ;;
    google-chat-message)
        run_in_venv cli_tools.google_chat.cli "$@"
        ;;
    db-query)
        run_in_venv cli_tools.db_query.cli "$@"
        ;;
    cloud-logs)
        run_in_venv cli_tools.cloud_logs.cli "$@"
        ;;
    followup)
        run_in_venv cli_tools.followup.cli "$@"
        ;;
    *)
        echo "Unknown command: $COMMAND" >&2
        echo "Available commands: $AVAILABLE_COMMANDS" >&2
        exit 1
        ;;
esac
