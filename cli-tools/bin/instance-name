#!/usr/bin/env bash
# Instance Name - Rename current session in Token-API registry
# TAGS: instance
# AUDIENCE: agent
#
# Usage: instance-name <name> [--id <instance-id>]
#
# Examples:
#   instance-name "auth-refactor"
#   instance-name "fix-bug" --id abc123

set -euo pipefail

API_URL="${TOKEN_API_URL:-http://100.95.109.23:7777}"

# Help
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    cat << 'EOF'
Instance Name - Rename current session in Token-API registry

Usage: instance-name <name> [--id <instance-id>]

Sets the display name for this Claude Code session in the Token-API
registry dashboard. The name helps identify what you're working on.

Options:
  --id <id>    Explicit instance ID (for ambiguous cases)

Instance Resolution (in order):
  1. --id flag if provided
  2. TOKEN_API_INSTANCE_ID env var (set by SessionStart hook)
  3. PID-based lookup via ~/.claude/session-pids/<claude-pid>
  4. PID field match in API instances list
  5. CWD match (processing instances preferred over idle)

Examples:
  instance-name "auth-refactor"
  instance-name "fix-bug-123"
  instance-name "feature/payments" --id abc123-def456
EOF
    exit 0
fi

# Parse arguments
NAME=""
EXPLICIT_ID=""
while [[ $# -gt 0 ]]; do
    case "$1" in
        --id)
            EXPLICIT_ID="$2"
            shift 2
            ;;
        *)
            NAME="$1"
            shift
            ;;
    esac
done

# Require name
if [[ -z "$NAME" ]]; then
    echo "Usage: instance-name <name> [--id <instance-id>]" >&2
    exit 1
fi

# Find parent claude process PID by walking up the process tree
_find_claude_pid() {
    local current="$PPID"
    local comm
    for _ in 1 2 3 4 5; do
        [[ -z "$current" || "$current" == "1" ]] && break
        comm=$(ps -o comm= -p "$current" 2>/dev/null || true)
        if [[ "$comm" == "claude" ]]; then
            echo "$current"
            return 0
        fi
        current=$(ps -o ppid= -p "$current" 2>/dev/null | tr -d ' ' || true)
    done
    return 1
}

# Resolve instance ID (priority: --id > env var > pid-cache > pid-api > cwd)
if [[ -n "$EXPLICIT_ID" ]]; then
    INSTANCE_ID="$EXPLICIT_ID"
elif [[ -n "${TOKEN_API_INSTANCE_ID:-}" ]]; then
    INSTANCE_ID="$TOKEN_API_INSTANCE_ID"
else
    INSTANCE_ID=""

    # Method 1: PID-based cache lookup (fastest, most reliable)
    # generic-hook.sh writes ~/.claude/session-pids/<claude-pid> on SessionStart
    CLAUDE_PID=$(_find_claude_pid 2>/dev/null || true)
    if [[ -n "$CLAUDE_PID" ]]; then
        SESSION_PID_FILE="${HOME}/.claude/session-pids/${CLAUDE_PID}"
        if [[ -f "$SESSION_PID_FILE" ]]; then
            INSTANCE_ID=$(cat "$SESSION_PID_FILE" 2>/dev/null || true)
        fi
    fi

    # Method 2: PID field match in API (still reliable, requires API call)
    if [[ -z "$INSTANCE_ID" ]] && [[ -n "${CLAUDE_PID:-}" ]]; then
        INSTANCES=$(curl -s --connect-timeout 3 "$API_URL/api/instances" 2>/dev/null || true)
        if [[ -n "$INSTANCES" ]]; then
            INSTANCE_ID=$(echo "$INSTANCES" | \
                jq -r --argjson pid "$CLAUDE_PID" \
                    '.[] | select(.pid == $pid and (.status == "processing" or .status == "idle")) | .id' 2>/dev/null | \
                head -1 || true)
        fi
    fi

    # Method 3: CWD match (least reliable - multiple sessions may share a working dir)
    # Prefer "processing" status over "idle" to pick the active instance
    if [[ -z "$INSTANCE_ID" ]]; then
        CWD="$(pwd)"
        INSTANCES="${INSTANCES:-$(curl -s --connect-timeout 3 "$API_URL/api/instances" 2>/dev/null || true)}"
        if [[ -n "$INSTANCES" ]]; then
            # Try processing first, then idle
            INSTANCE_ID=$(echo "$INSTANCES" | \
                jq -r --arg cwd "$CWD" \
                    '[ .[] | select(.status == "processing" and .working_dir == $cwd) ] | .[0].id // ""' \
                    2>/dev/null || true)
            if [[ -z "$INSTANCE_ID" ]]; then
                INSTANCE_ID=$(echo "$INSTANCES" | \
                    jq -r --arg cwd "$CWD" \
                        '[ .[] | select(.status == "idle" and .working_dir == $cwd) ] | .[0].id // ""' \
                        2>/dev/null || true)
            fi
        fi
    fi
fi

if [[ -z "$INSTANCE_ID" ]]; then
    echo "Error: No active instance found. Use --id to specify explicitly." >&2
    exit 1
fi

# Rename
RESPONSE=$(curl -s -X PATCH "$API_URL/api/instances/$INSTANCE_ID/rename" \
    -H "Content-Type: application/json" \
    -d "{\"tab_name\": \"$NAME\"}" 2>/dev/null || true)

if echo "$RESPONSE" | jq -e '.status == "renamed"' >/dev/null 2>&1; then
    echo "Renamed to: $NAME"
else
    echo "Error: $(echo "$RESPONSE" | jq -r '.detail // "rename failed"' 2>/dev/null || echo "rename failed")" >&2
    exit 1
fi
