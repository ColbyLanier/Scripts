#!/usr/bin/env python3
# timer-ps1 - Compact timer output for PS1 prompt embedding
# TAGS: token-api
# AUDIENCE: human, agent
"""Compact timer status for PS1 prompt embedding.

Outputs a single token like `ðŸ’¼+14m` or `â˜•-2m` suitable for
embedding in a zsh/bash PROMPT via `$(timer-ps1)`.

Usage:
    timer-ps1              # ðŸ’¼+14m  (no ANSI, PS1-safe)
    timer-ps1 --ansi       # Same but with colors (for direct terminal display)
    timer-ps1 --icon-only  # Just the mode emoji (e.g. ðŸ’¼)
    timer-ps1 --help

Output format:
    <icon><+/-><value><unit>   e.g. ðŸ’¼+14m, â˜•-2m, ðŸ’¼+2h3m, ðŸŒ™
    Empty string on server down (keeps PS1 clean).

Notes:
    - No trailing newline issues; uses print() which adds exactly one newline.
    - No ANSI codes by default â€” safe for PS1 `$()` substitution.
    - Timeout: 0.5s â€” won't lag the prompt if server is down.
    - Sleeping and idle modes omit balance (not meaningful).
    - For ANSI prompt use, wrap in %%{ ... %%} (zsh) around color codes if needed.
"""

import sys
import json
import urllib.request

API_URL = "http://localhost:7777"

MODE_ICONS = {
    "working":      "\U0001f4bc",   # ðŸ’¼
    "multitasking": "\u26a1",       # âš¡
    "idle":         "\u23f8",       # â¸
    "distracted":   "\u26a0\ufe0f", # âš ï¸
    "break":        "\u2615",       # â˜•
    "sleeping":     "\U0001f319",   # ðŸŒ™
}

# Modes where showing balance is meaningful
BALANCE_MODES = {"working", "multitasking", "break", "distracted"}


def get_timer():
    try:
        req = urllib.request.Request(f"{API_URL}/api/timer", method="GET")
        with urllib.request.urlopen(req, timeout=0.5) as resp:
            return json.loads(resp.read().decode())
    except Exception:
        return None


def fmt_balance_compact(seconds):
    """Format seconds as compact balance: +14m, -2m, +2h3m, +45s."""
    sign = "+" if seconds >= 0 else "-"
    abs_s = abs(int(seconds))
    if abs_s < 60:
        return f"{sign}{abs_s}s"
    elif abs_s < 3600:
        return f"{sign}{abs_s // 60}m"
    else:
        h = abs_s // 3600
        m = (abs_s % 3600) // 60
        if m == 0:
            return f"{sign}{h}h"
        return f"{sign}{h}h{m:02d}m"


def color(text, code):
    """ANSI color wrapper."""
    return f"\033[{code}m{text}\033[0m"


def main():
    args = sys.argv[1:]

    if "--help" in args or "-h" in args:
        print(__doc__.strip())
        return

    use_ansi = "--ansi" in args
    icon_only = "--icon-only" in args

    data = get_timer()
    if not data:
        # Silent on server down â€” PS1 stays clean
        return

    mode = (data.get("current_mode") or "").lower()
    icon = MODE_ICONS.get(mode, "?")

    if icon_only:
        print(icon)
        return

    # Compute balance
    if data.get("is_in_backlog"):
        bal_s = -round(data.get("break_backlog_ms", 0) / 1000)
    else:
        bal_s = data.get("accumulated_break_seconds", 0)

    # Modes where balance is not meaningful â€” just show icon
    if mode not in BALANCE_MODES:
        print(icon)
        return

    bal_str = fmt_balance_compact(bal_s)

    if use_ansi:
        if bal_s > 1800:
            bal_colored = color(bal_str, "32")   # green
        elif bal_s > 0:
            bal_colored = color(bal_str, "33")   # yellow
        else:
            bal_colored = color(bal_str, "31")   # red
        print(f"{icon}{bal_colored}")
    else:
        print(f"{icon}{bal_str}")


if __name__ == "__main__":
    main()
