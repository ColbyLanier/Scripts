#!/usr/bin/env bash
# discord-send - Send Discord message (DEPRECATED: use `discord send` instead)
# TAGS: claw, discord
# AUDIENCE: agent, human
#
# This script now wraps `discord send`. Use `discord send` directly.
#
# Usage: discord-send --target <channel_id> --message "text" [--channel discord]

set -euo pipefail

# Check if new daemon is available
if curl -sf "http://127.0.0.1:7779/status" >/dev/null 2>&1; then
  # Parse old-style args
  TARGET="" MESSAGE=""
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --target)  TARGET="$2"; shift 2 ;;
      --message) MESSAGE="$2"; shift 2 ;;
      --channel) shift 2 ;;  # Ignore old --channel discord flag
      --dry-run) echo "[dry-run] Would send to $TARGET: $MESSAGE"; exit 0 ;;
      *) shift ;;
    esac
  done
  [[ -z "$TARGET" || -z "$MESSAGE" ]] && { echo "Error: --target and --message required" >&2; exit 1; }
  exec discord send "$TARGET" "$MESSAGE"
fi

# Legacy fallback
echo "Warning: discord daemon not running, falling back to openclaw" >&2
openclaw message send --channel discord "$@"

DRY=0
for arg in "$@"; do [[ "$arg" == "--dry-run" ]] && DRY=1; done
if [[ "$DRY" -eq 0 ]]; then
  discord-context --limit 10 >/dev/null 2>&1 &
fi
