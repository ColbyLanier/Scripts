#!/usr/bin/env bash
# session-state - Read/write structured state for cron agents between isolated sessions
# TAGS: claw, session, cron
# AUDIENCE: agent
#
# Usage:
#   session-state get <agent-name> [key]          # Read state (whole JSON or one key)
#   session-state set <agent-name> <key> <value>  # Set a key in agent's state JSON
#   session-state clear <agent-name>              # Clear all state for agent
#   session-state list                             # List all agents with state files
#
# State stored in: ~/.openclaw/workspace/memory/session-states/<agent-name>.json

set -euo pipefail

STATE_DIR="$HOME/.openclaw/workspace/memory/session-states"
mkdir -p "$STATE_DIR"

usage() {
  echo "Usage:"
  echo "  session-state get <agent-name> [key]"
  echo "  session-state set <agent-name> <key> <value>"
  echo "  session-state clear <agent-name>"
  echo "  session-state list"
  exit 1
}

[[ $# -lt 1 ]] && usage

CMD="$1"
shift

case "$CMD" in
  get)
    [[ $# -lt 1 ]] && { echo "Error: get requires <agent-name>"; usage; }
    AGENT="$1"
    KEY="${2:-}"
    FILE="$STATE_DIR/$AGENT.json"
    if [[ ! -f "$FILE" ]]; then
      if [[ -n "$KEY" ]]; then
        echo "null"
      else
        echo "{}"
      fi
      exit 0
    fi
    if [[ -n "$KEY" ]]; then
      jq -r --arg k "$KEY" '.[$k] // "null"' "$FILE"
    else
      jq . "$FILE"
    fi
    ;;

  set)
    [[ $# -lt 3 ]] && { echo "Error: set requires <agent-name> <key> <value>"; usage; }
    AGENT="$1"
    KEY="$2"
    VALUE="$3"
    FILE="$STATE_DIR/$AGENT.json"
    if [[ ! -f "$FILE" ]]; then
      echo "{}" > "$FILE"
    fi
    TMP=$(mktemp)
    jq --arg k "$KEY" --arg v "$VALUE" '.[$k] = $v' "$FILE" > "$TMP"
    mv "$TMP" "$FILE"
    echo "Set $AGENT.$KEY = $VALUE"
    ;;

  clear)
    [[ $# -lt 1 ]] && { echo "Error: clear requires <agent-name>"; usage; }
    AGENT="$1"
    FILE="$STATE_DIR/$AGENT.json"
    if [[ -f "$FILE" ]]; then
      rm "$FILE"
      echo "Cleared state for $AGENT"
    else
      echo "No state found for $AGENT"
    fi
    ;;

  list)
    if [[ -z "$(ls -A "$STATE_DIR" 2>/dev/null)" ]]; then
      echo "No agents with state files."
    else
      echo "Agents with state:"
      for f in "$STATE_DIR"/*.json; do
        [[ -f "$f" ]] || continue
        AGENT_NAME=$(basename "$f" .json)
        KEY_COUNT=$(jq 'keys | length' "$f" 2>/dev/null || echo "?")
        echo "  $AGENT_NAME ($KEY_COUNT keys)"
      done
    fi
    ;;

  *)
    echo "Unknown command: $CMD"
    usage
    ;;
esac
