#!/usr/bin/env bash
# validate-file - Validate a file before it's accepted (shell syntax, python syntax, executable test)
# TAGS: claw, validation, safety
# AUDIENCE: agent
#
# Usage:
#   validate-file <path>              # Auto-detect type and validate
#   validate-file <path> --test-run   # Also attempt to run with --help
#   validate-file <path> --type sh    # Force type (sh|py|json|md)
#
# Exit codes: 0=pass, 1=fail, 2=unknown type
# Prints: PASS or FAIL + reason

set -uo pipefail

usage() {
  echo "Usage: validate-file <path> [--test-run] [--type sh|py|json|md]"
  exit 2
}

[[ $# -lt 1 ]] && usage

FILE="$1"
shift

TEST_RUN=0
FORCE_TYPE=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --test-run) TEST_RUN=1; shift ;;
    --type) FORCE_TYPE="$2"; shift 2 ;;
    *) echo "Unknown option: $1"; usage ;;
  esac
done

if [[ ! -f "$FILE" ]]; then
  echo "FAIL: file not found: $FILE"
  exit 1
fi

# Detect type
if [[ -n "$FORCE_TYPE" ]]; then
  TYPE="$FORCE_TYPE"
else
  case "$FILE" in
    *.sh)   TYPE="sh" ;;
    *.py)   TYPE="py" ;;
    *.json) TYPE="json" ;;
    *.md)   TYPE="md" ;;
    *)
      # Try shebang detection
      SHEBANG=$(head -1 "$FILE" 2>/dev/null || true)
      if [[ "$SHEBANG" == *"bash"* || "$SHEBANG" == *"sh"* ]]; then
        TYPE="sh"
      elif [[ "$SHEBANG" == *"python"* ]]; then
        TYPE="py"
      else
        echo "FAIL: unknown file type (no extension match, no recognized shebang)"
        exit 2
      fi
      ;;
  esac
fi

# Validate by type
FAIL_REASON=""
case "$TYPE" in
  sh)
    if ! ERR=$(bash -n "$FILE" 2>&1); then
      FAIL_REASON="shell syntax error: $ERR"
    fi
    ;;
  py)
    if ! ERR=$(python3 -m py_compile "$FILE" 2>&1); then
      FAIL_REASON="python syntax error: $ERR"
    fi
    ;;
  json)
    if ! ERR=$(jq --exit-status . "$FILE" > /dev/null 2>&1); then
      FAIL_REASON="JSON parse error: $(jq . "$FILE" 2>&1)"
    fi
    ;;
  md)
    # Markdown always passes (no syntax to check)
    ;;
  *)
    echo "FAIL: unsupported type: $TYPE"
    exit 2
    ;;
esac

if [[ -n "$FAIL_REASON" ]]; then
  echo "FAIL: $FAIL_REASON"
  exit 1
fi

echo "PASS: $TYPE syntax ok ($FILE)"

# Optional test-run
if [[ "$TEST_RUN" -eq 1 && -x "$FILE" ]]; then
  echo "--- test-run (--help) ---"
  "$FILE" --help 2>&1 | head -3 || true
fi

exit 0
