#!/usr/bin/env python3
# notify - Send notifications via Token-API (TTS + sound)
# TAGS: token-api
# AUDIENCE: human, agent
"""Send notifications via Token-API.

Usage:
    notify "Hello world"              # TTS + default sound
    notify --queue "Hello world"      # Queue via instance profile (uses assigned voice)
    notify --tts-only "Hello world"   # TTS only, no sound
    notify --sound-only               # Play notification sound only
    notify --test                     # Trigger built-in API test notification
    notify --sound Glass.aiff         # TTS with specific sound file
    notify --voice "Karen" "Hey"      # Override TTS voice
    notify -h, --help                 # Show this help

Flags:
    --queue         Use profile-aware TTS queue (auto-detects current instance)
    --instance ID   Specify instance ID explicitly (use with --queue)
    --tts-only      Skip sound, speak only
    --sound-only    Skip TTS, play sound only
    --sound FILE    Override sound file (e.g. Glass.aiff, Ping.aiff)
    --voice VOICE   Override TTS voice (e.g. Karen, Daniel, Moira)
    --test          Trigger /api/notify/test (built-in server test)
    --raw           Print raw JSON response

Queue mode routes through the instance's assigned voice/sound profile (WSL SAPI voices),
respects tts_mode (verbose/muted/silent) and quiet hours. Best for agent notifications.
"""

import os
import sys
import json
import sqlite3
import subprocess
import urllib.request
import urllib.error

API_URL = "http://localhost:7777"

RED = "\033[31m"
GREEN = "\033[32m"
YELLOW = "\033[33m"
RESET = "\033[0m"


def request(method, path, body=None):
    url = f"{API_URL}{path}"
    try:
        req = urllib.request.Request(url, method=method)
        if body is not None:
            req.add_header("Content-Type", "application/json")
            req.data = json.dumps(body).encode()
        with urllib.request.urlopen(req, timeout=10) as resp:
            raw = resp.read().decode()
            return resp.status, json.loads(raw) if raw.strip() else {}
    except urllib.error.HTTPError as e:
        body_text = e.read().decode()
        try:
            data = json.loads(body_text)
        except Exception:
            data = {"detail": body_text}
        return e.code, data
    except Exception as e:
        return 0, {"detail": str(e)}


def find_instance_id():
    """Walk process tree to find Claude ancestor PID, then look up in agents.db."""
    db_path = os.path.expanduser("~/.claude/agents.db")
    if not os.path.exists(db_path):
        return None

    # Walk process tree looking for a 'claude' process
    current_pid = os.getpid()
    claude_pid = None
    for _ in range(10):
        try:
            out = subprocess.check_output(
                ["ps", "-p", str(current_pid), "-o", "ppid=,comm="],
                text=True, stderr=subprocess.DEVNULL
            ).strip()
            parts = out.split(None, 1)
            if len(parts) < 2:
                break
            ppid = int(parts[0])
            comm = parts[1].strip()
            if comm == "claude":
                claude_pid = current_pid
                break
            if ppid <= 1:
                break
            current_pid = ppid
        except Exception:
            break

    if not claude_pid:
        return None

    try:
        conn = sqlite3.connect(db_path)
        cursor = conn.execute(
            "SELECT id FROM claude_instances WHERE pid = ? AND status != 'stopped' LIMIT 1",
            (claude_pid,)
        )
        row = cursor.fetchone()
        conn.close()
        return row[0] if row else None
    except Exception:
        return None


def print_result(status, data, raw=False):
    if raw:
        print(json.dumps(data, indent=2))
        return
    if status == 0:
        print(f"{RED}Connection failed: {data.get('detail', 'unknown')}{RESET}", file=sys.stderr)
        sys.exit(1)
    if status >= 400:
        detail = data.get("detail", data) if isinstance(data, dict) else data
        print(f"{RED}Error {status}: {detail}{RESET}", file=sys.stderr)
        sys.exit(1)
    # Success: print meaningful summary
    if isinstance(data, dict):
        msg = data.get("message") or data.get("status") or data.get("detail")
        if msg:
            print(f"{GREEN}✓{RESET} {msg}")
        else:
            print(f"{GREEN}✓{RESET} OK")
    else:
        print(f"{GREEN}✓{RESET} OK")


def parse_args(argv):
    result = {
        "message": None,
        "queue": False,
        "instance": None,
        "tts_only": False,
        "sound_only": False,
        "test": False,
        "sound": None,
        "voice": None,
        "raw": False,
    }

    i = 0
    while i < len(argv):
        arg = argv[i]
        if arg in ("-h", "--help"):
            print(__doc__.strip())
            sys.exit(0)
        elif arg == "--queue":
            result["queue"] = True
        elif arg == "--instance" and i + 1 < len(argv):
            result["instance"] = argv[i + 1]
            i += 2
            continue
        elif arg == "--tts-only":
            result["tts_only"] = True
        elif arg == "--sound-only":
            result["sound_only"] = True
        elif arg == "--test":
            result["test"] = True
        elif arg == "--raw":
            result["raw"] = True
        elif arg == "--sound" and i + 1 < len(argv):
            result["sound"] = argv[i + 1]
            i += 2
            continue
        elif arg == "--voice" and i + 1 < len(argv):
            result["voice"] = argv[i + 1]
            i += 2
            continue
        elif not arg.startswith("-") and result["message"] is None:
            result["message"] = arg
        i += 1

    return result


def main():
    args = parse_args(sys.argv[1:])

    if args["test"]:
        status, data = request("GET", "/api/notify/test")
        print_result(status, data, raw=args["raw"])
        return

    if args["queue"]:
        if not args["message"]:
            print(f"{RED}Error: message required for --queue{RESET}", file=sys.stderr)
            sys.exit(1)
        instance_id = args["instance"] or find_instance_id()
        if not instance_id:
            print(f"{RED}Error: could not detect current instance ID{RESET}", file=sys.stderr)
            print(f"  Use --instance <ID> to specify explicitly", file=sys.stderr)
            print(f"  Or run: agents-db instances", file=sys.stderr)
            sys.exit(1)
        body = {"instance_id": instance_id, "message": args["message"]}
        status, data = request("POST", "/api/notify/queue", body)
        if not args["raw"] and status < 400 and status != 0:
            queued = data.get("queued", False)
            voice = data.get("voice", "")
            pos = data.get("position", "")
            reason = data.get("reason", "")
            if queued:
                pos_str = f" (position {pos})" if pos else ""
                voice_str = f" [{voice}]" if voice else ""
                print(f"{GREEN}✓{RESET} Queued{pos_str}{voice_str}")
            else:
                print(f"{YELLOW}~{RESET} Not queued: {reason}")
            return
        print_result(status, data, raw=args["raw"])
        return

    if args["sound_only"]:
        body = {}
        if args["sound"]:
            body["sound_file"] = args["sound"]
        status, data = request("POST", "/api/notify/sound", body)
        print_result(status, data, raw=args["raw"])
        return

    if args["tts_only"]:
        if not args["message"]:
            print(f"{RED}Error: message required for --tts-only{RESET}", file=sys.stderr)
            sys.exit(1)
        body = {"message": args["message"]}
        if args["voice"]:
            body["voice"] = args["voice"]
        status, data = request("POST", "/api/notify/tts", body)
        print_result(status, data, raw=args["raw"])
        return

    # Default: full notification (TTS + sound)
    if not args["message"]:
        print(f"{RED}Error: message required{RESET}", file=sys.stderr)
        print("Usage: notify \"Your message\"  (run with --help for options)", file=sys.stderr)
        sys.exit(1)

    body = {"message": args["message"]}
    if args["voice"]:
        body["voice"] = args["voice"]
    if args["sound"]:
        body["sound"] = args["sound"]

    status, data = request("POST", "/api/notify", body)
    print_result(status, data, raw=args["raw"])


if __name__ == "__main__":
    main()
