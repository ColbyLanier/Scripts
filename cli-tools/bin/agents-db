#!/usr/bin/env python3
"""Query the local agents.db database (Token-API instance registry).

Usage:
    agents-db tables                        # List all tables
    agents-db describe <table>              # Show table schema
    agents-db query "SELECT * FROM ..."     # Run SQL query
    agents-db instances                     # Show active instances
    agents-db events [--limit N]            # Show recent events
"""

import sys
import json
import sqlite3
from pathlib import Path

DB_PATH = Path.home() / ".claude" / "agents.db"


def get_connection():
    if not DB_PATH.exists():
        print(f"Error: Database not found at {DB_PATH}", file=sys.stderr)
        sys.exit(1)
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    return conn


def cmd_tables():
    """List all tables."""
    conn = get_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name")
    for row in cursor.fetchall():
        print(row["name"])
    conn.close()


def cmd_describe(table_name: str):
    """Show table schema."""
    conn = get_connection()
    cursor = conn.cursor()
    try:
        cursor.execute(f"PRAGMA table_info({table_name})")
        rows = cursor.fetchall()
        if not rows:
            print(f"Table '{table_name}' not found", file=sys.stderr)
            sys.exit(1)
        print(f"Table: {table_name}")
        print("-" * 60)
        print(f"{'Column':<25} {'Type':<15} {'Nullable':<10} {'Default'}")
        print("-" * 60)
        for row in rows:
            nullable = "YES" if not row["notnull"] else "NO"
            default = row["dflt_value"] or ""
            print(f"{row['name']:<25} {row['type']:<15} {nullable:<10} {default}")
    finally:
        conn.close()


def cmd_query(sql: str, limit: int = 100, json_output: bool = False):
    """Run SQL query."""
    conn = get_connection()
    cursor = conn.cursor()
    try:
        # Auto-limit SELECT queries
        sql_upper = sql.strip().upper()
        if sql_upper.startswith("SELECT") and "LIMIT" not in sql_upper:
            sql = f"{sql.rstrip(';')} LIMIT {limit}"

        cursor.execute(sql)
        rows = cursor.fetchall()

        if not rows:
            print("No results")
            return

        # Get column names
        columns = [desc[0] for desc in cursor.description]

        if json_output:
            results = []
            for row in rows:
                d = dict(row)
                # Parse JSON fields
                for key, val in d.items():
                    if isinstance(val, str) and val.startswith('{'):
                        try:
                            d[key] = json.loads(val)
                        except:
                            pass
                results.append(d)
            print(json.dumps(results, indent=2, default=str))
        else:
            # Calculate column widths
            widths = {col: len(col) for col in columns}
            for row in rows:
                for col in columns:
                    val = str(row[col]) if row[col] is not None else "NULL"
                    widths[col] = max(widths[col], min(len(val), 40))

            # Print header
            header = " | ".join(col[:widths[col]].ljust(widths[col]) for col in columns)
            print(header)
            print("-" * len(header))

            # Print rows
            for row in rows:
                vals = []
                for col in columns:
                    val = str(row[col]) if row[col] is not None else "NULL"
                    if len(val) > 40:
                        val = val[:37] + "..."
                    vals.append(val.ljust(widths[col]))
                print(" | ".join(vals))
    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)
    finally:
        conn.close()


def cmd_instances(json_output: bool = False):
    """Show active instances."""
    sql = """
        SELECT id, tab_name, working_dir, status, device_id,
               datetime(last_activity) as last_activity
        FROM claude_instances
        ORDER BY status ASC, last_activity DESC
    """
    cmd_query(sql, limit=50, json_output=json_output)


def cmd_events(limit: int = 20, json_output: bool = False):
    """Show recent events."""
    sql = f"""
        SELECT id, event_type, instance_id, details,
               datetime(created_at) as created_at
        FROM events
        ORDER BY created_at DESC
        LIMIT {limit}
    """
    cmd_query(sql, limit=limit, json_output=json_output)


def main():
    args = sys.argv[1:]

    if not args or args[0] in ("-h", "--help"):
        print(__doc__)
        sys.exit(0)

    json_output = "--json" in args
    if json_output:
        args.remove("--json")

    cmd = args[0]

    if cmd == "tables":
        cmd_tables()
    elif cmd == "describe" and len(args) >= 2:
        cmd_describe(args[1])
    elif cmd == "query" and len(args) >= 2:
        cmd_query(" ".join(args[1:]), json_output=json_output)
    elif cmd == "instances":
        cmd_instances(json_output=json_output)
    elif cmd == "events":
        limit = 20
        for i, arg in enumerate(args):
            if arg == "--limit" and i + 1 < len(args):
                limit = int(args[i + 1])
        cmd_events(limit=limit, json_output=json_output)
    else:
        print(f"Unknown command: {cmd}", file=sys.stderr)
        print("Run with --help for usage", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
