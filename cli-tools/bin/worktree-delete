#!/usr/bin/env bash
# Worktree Delete - remove git worktrees and clean up associated resources
#
# Usage: worktree-delete <branch-name> [options]
#
# Removes the worktree directory, prunes git worktree references,
# optionally deletes the branch, and cleans up the cd quick alias.
#
# Examples:
#   worktree-delete feature-auth          # Remove worktree, keep branch
#   worktree-delete feature-auth -b       # Remove worktree AND delete branch
#   worktree-delete feature-auth --dry-run

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Defaults
DRY_RUN=false
DELETE_BRANCH=false

usage() {
    cat << 'EOF'
Worktree Delete - remove git worktrees and clean up associated resources

Usage: worktree-delete <branch-name> [options]

Arguments:
  branch-name         Branch/worktree to remove

Options:
  -b, --delete-branch  Also delete the local branch
  -n, --dry-run        Show what would happen without making changes
  -h, --help           Show this help message

Cleanup performed:
  - Removes the worktree directory
  - Prunes git worktree references
  - Removes the cd quick alias (~/.cd_quick_aliases)
  - Optionally deletes the local branch (-b)

Examples:
  worktree-delete feature-auth          # Remove worktree, keep branch
  worktree-delete feature-auth -b       # Also delete the branch
  worktree-delete feature-auth --dry-run
EOF
    exit 0
}

log_info() { echo -e "${BLUE}→${NC} $1"; }
log_success() { echo -e "${GREEN}✓${NC} $1"; }
log_warn() { echo -e "${YELLOW}!${NC} $1"; }
log_error() { echo -e "${RED}✗${NC} $1"; }

# Parse arguments
BRANCH_NAME=""
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help) usage ;;
        -n|--dry-run) DRY_RUN=true; shift ;;
        -b|--delete-branch) DELETE_BRANCH=true; shift ;;
        -*)
            log_error "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
        *)
            if [[ -z "$BRANCH_NAME" ]]; then
                BRANCH_NAME="$1"
            else
                log_error "Too many arguments"
                exit 1
            fi
            shift
            ;;
    esac
done

if [[ -z "$BRANCH_NAME" ]]; then
    log_error "Branch name required"
    echo "Usage: worktree-delete <branch-name> [options]"
    exit 1
fi

# Check we're in a git repo
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    log_error "Not in a git repository"
    exit 1
fi

REPO_ROOT=$(git rev-parse --show-toplevel)
REPO_NAME=$(basename "$REPO_ROOT")
PARENT_DIR=$(dirname "$REPO_ROOT")
WORKTREE_DIR="$PARENT_DIR/${REPO_NAME}-${BRANCH_NAME}"

# Verify worktree exists
if [[ ! -d "$WORKTREE_DIR" ]]; then
    # Still try to clean up alias and prune
    log_warn "Worktree directory not found: $WORKTREE_DIR"
    log_info "Will still clean up alias and prune references..."
fi

CD_QUICK_ALIASES_FILE="$HOME/.cd_quick_aliases"
HAS_ALIAS=false
if grep -q "^${BRANCH_NAME}=" "$CD_QUICK_ALIASES_FILE" 2>/dev/null; then
    HAS_ALIAS=true
fi

# Show plan
echo ""
echo "═══════════════════════════════════════════════════════════════"
echo " Worktree Delete Plan"
echo "═══════════════════════════════════════════════════════════════"
echo ""
echo "  Repository:    $REPO_NAME"
echo "  Branch:        $BRANCH_NAME"
echo "  Worktree:      $WORKTREE_DIR"
echo "  Delete branch: $(if $DELETE_BRANCH; then echo "yes"; else echo "no"; fi)"
echo "  CD alias:      $(if $HAS_ALIAS; then echo "will remove"; else echo "none found"; fi)"
echo ""
echo "═══════════════════════════════════════════════════════════════"
echo ""

if [[ "$DRY_RUN" == "true" ]]; then
    log_warn "Dry run - no changes made"
    exit 0
fi

# Remove worktree
if [[ -d "$WORKTREE_DIR" ]]; then
    log_info "Removing worktree..."
    git worktree remove "$WORKTREE_DIR" --force
    log_success "Worktree removed: $WORKTREE_DIR"
else
    log_info "Pruning stale worktree references..."
    git worktree prune
    log_success "Pruned worktree references"
fi

# Delete branch if requested
if [[ "$DELETE_BRANCH" == "true" ]]; then
    if git branch --list "$BRANCH_NAME" | grep -q .; then
        log_info "Deleting local branch..."
        git branch -D "$BRANCH_NAME"
        log_success "Branch deleted: $BRANCH_NAME"
    else
        log_warn "Branch '$BRANCH_NAME' not found locally (may already be deleted)"
    fi
fi

# Remove cd quick alias
if $HAS_ALIAS; then
    log_info "Removing cd alias..."
    sed -i "/^${BRANCH_NAME}=/d" "$CD_QUICK_ALIASES_FILE"
    log_success "CD alias removed: $BRANCH_NAME"
fi

echo ""
echo "═══════════════════════════════════════════════════════════════"
echo -e " ${GREEN}Worktree cleaned up!${NC}"
echo "═══════════════════════════════════════════════════════════════"
echo ""
