#!/usr/bin/env python3
# token-status - Quick Token-API status check
# TAGS: token-api
# AUDIENCE: human, agent
"""Quick Token-API status check without launching full TUI.

Usage:
    token-status              # Show active instances and server health
    token-status --watch      # Continuous monitoring (2s refresh)
    token-status --json       # JSON output
"""

import sys
import json
import urllib.request
from datetime import datetime

API_URL = "http://localhost:7777"


def check_health():
    try:
        req = urllib.request.Request(f"{API_URL}/health", method="GET")
        with urllib.request.urlopen(req, timeout=2) as resp:
            return True, json.loads(resp.read().decode())
    except Exception as e:
        return False, str(e)


def get_instances():
    try:
        req = urllib.request.Request(f"{API_URL}/api/instances", method="GET")
        with urllib.request.urlopen(req, timeout=2) as resp:
            return json.loads(resp.read().decode())
    except Exception:
        return []


def format_duration(registered_at):
    try:
        start = datetime.fromisoformat(registered_at.replace("Z", "+00:00"))
        delta = datetime.now() - start.replace(tzinfo=None)
        mins = int(delta.total_seconds() // 60)
        if mins >= 60:
            return f"{mins // 60}h{mins % 60}m"
        return f"{mins}m"
    except:
        return "?"


def display_status(json_output=False):
    healthy, health_data = check_health()
    instances = get_instances()

    if json_output:
        print(json.dumps({
            "healthy": healthy,
            "health": health_data if healthy else None,
            "instances": instances
        }, indent=2, default=str))
        return

    # Header
    status_icon = "\033[32m●\033[0m" if healthy else "\033[31m●\033[0m"
    print(f"{status_icon} Token-API @ localhost:7777")

    if not healthy:
        print(f"  \033[31mError: {health_data}\033[0m")
        return

    # Instances
    active = [i for i in instances if i.get("status") in ("processing", "idle")]
    stopped = [i for i in instances if i.get("status") == "stopped"]

    print(f"\n  Active: {len(active)}  Stopped: {len(stopped)}")

    if active:
        print()
        for inst in active:
            name = inst.get("tab_name") or inst.get("working_dir", "?").split("/")[-1]
            if name.startswith("Claude ") and len(name) == 11:  # "Claude HH:MM"
                wd = inst.get("working_dir", "")
                name = "/".join(wd.split("/")[-2:]) if wd else name
            device = inst.get("device_id", "?")
            duration = format_duration(inst.get("registered_at", ""))
            processing = " \033[33m>\033[0m" if inst.get("status") == "processing" else "  "
            print(f"  {processing} {name[:25]:<25} {device:<12} {duration}")


def main():
    args = sys.argv[1:]

    if "--help" in args or "-h" in args:
        print(__doc__)
        sys.exit(0)

    json_output = "--json" in args

    if "--watch" in args or "-w" in args:
        import time
        try:
            while True:
                print("\033[2J\033[H", end="")  # Clear screen
                display_status(json_output=json_output)
                print(f"\n  \033[2m(Ctrl+C to exit, refreshing every 2s)\033[0m")
                time.sleep(2)
        except KeyboardInterrupt:
            print()
    else:
        display_status(json_output=json_output)


if __name__ == "__main__":
    main()
