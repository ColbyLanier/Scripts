#!/usr/bin/env bash
# Deploy CLI - wrapper for Claude Code deployment system
#
# Usage: deploy [service] [target] [options]
#
# Services: backend (default), web, widget-proxy, chat-proxy, proxies
# Targets: dev (default), prod, local, debug
# Options: -b/--blocking, -p/--skip-build, -y/--skip-push
#
# Examples:
#   deploy                        # Backend to dev async
#   deploy prod                   # Backend to prod async
#   deploy web                    # Frontend to dev
#   deploy web prod               # Frontend to prod
#   deploy proxies                # Both proxies to dev
#   deploy local                  # Local backend server

set -euo pipefail

DEPLOY_DIR="$HOME/Scripts/cli-tools/src/deploy"

# Check if help is requested
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    cat << 'EOF'
Deploy CLI - Claude Code deployment system

Usage: deploy [service] [target] [options]

Services:
  backend             Main application (default if no service specified)
  web, frontend       Widget/frontend application
  widget-proxy        Widget proxy service
  chat-proxy          Google Chat proxy service
  proxies             Both widget-proxy and chat-proxy

Targets (for backend service):
  dev, development    Cloud development deployment (default)
  prod, production    Cloud production deployment
  local               Local continuous server with ngrok
  debug               Local server with debugpy on port 5678

Targets (for web/proxy services):
  dev, development    Development environment (default)
  prod, production    Production environment

Options:
  -b, --blocking      Wait for completion, monitor errors
  -p, --skip-build    Use last built image (skip docker build)
  -y, --skip-push     Use last pushed image (skip build + push)

Request Options (for local deployments):
  --request-endpoint <path>     Endpoint to call after health check
  --request-method <method>     HTTP method (default: GET)
  --request-body <json>         Request body as JSON string
  --request-headers <json>      Custom headers as JSON object
  --force-localhost             Use localhost instead of ngrok
  --localhost                   Alias for --force-localhost

One-Shot Testing:
  --one-shot          Start -> health check -> request -> stop
  --test-and-stop     Alias for --one-shot
  --auto-stop         Alias for --one-shot

Google Chat Testing:
  --google-chat-message <text>  Send test message (auto-configures request)

Examples:
  # Backend deployments
  deploy                        # Dev async deployment
  deploy prod                   # Prod async deployment
  deploy -b                     # Dev blocking (wait for completion)
  deploy prod -b                # Prod blocking
  deploy local                  # Local server (continuous)
  deploy local -b               # Local with health monitoring
  deploy debug                  # Local with debugger

  # Frontend deployments
  deploy web                    # Frontend to dev
  deploy web prod               # Frontend to prod
  deploy frontend local         # Local frontend + backend

  # Proxy deployments
  deploy widget-proxy           # Widget proxy to dev
  deploy chat-proxy prod        # Chat proxy to prod
  deploy proxies                # Both proxies to dev
  deploy proxies prod           # Both proxies to prod

  # Testing
  deploy local -b --google-chat-message "hello"
  deploy local -b --one-shot --google-chat-message "test"

Legacy Syntax (deprecated):
  deploy -l                     # Use: deploy local
  deploy -d                     # Use: deploy debug
EOF
    exit 0
fi

# Require a git repository context
GIT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null) || {
    echo "Error: must be run from within a git repository" >&2
    exit 1
}

# Verify trigger-deploy.js exists
if [[ ! -f "$DEPLOY_DIR/trigger-deploy.js" ]]; then
    echo "Error: Deploy system not found at $DEPLOY_DIR" >&2
    exit 1
fi

# Parse service type from first argument
SERVICE=""
ARGS=()
FIRST_ARG_PROCESSED=false

for arg in "$@"; do
    if [[ "$FIRST_ARG_PROCESSED" == "false" && ! "$arg" =~ ^- ]]; then
        case "$arg" in
            web|frontend)
                SERVICE="web"
                FIRST_ARG_PROCESSED=true
                continue
                ;;
            widget-proxy)
                SERVICE="widget-proxy"
                FIRST_ARG_PROCESSED=true
                continue
                ;;
            chat-proxy)
                SERVICE="chat-proxy"
                FIRST_ARG_PROCESSED=true
                continue
                ;;
            proxies)
                SERVICE="proxies"
                FIRST_ARG_PROCESSED=true
                continue
                ;;
            backend)
                SERVICE="backend"
                FIRST_ARG_PROCESSED=true
                continue
                ;;
        esac
    fi
    ARGS+=("$arg")
done

# Execute from the project directory
cd "$GIT_ROOT"

# Determine environment from remaining args
ENV="development"
for arg in "${ARGS[@]}"; do
    case "$arg" in
        prod|production) ENV="production" ;;
        dev|development) ENV="development" ;;
    esac
done

# Handle different service types
case "$SERVICE" in
    web)
        echo "Deploying frontend to $ENV..."
        if [[ " ${ARGS[*]} " =~ " local " ]]; then
            exec make deploy-web FLAG=-l ENVIRONMENT="$ENV"
        else
            exec make deploy-web ENVIRONMENT="$ENV"
        fi
        ;;
    widget-proxy)
        echo "Deploying widget-proxy to $ENV..."
        exec make deploy-widget-proxy ENVIRONMENT="$ENV"
        ;;
    chat-proxy)
        echo "Deploying chat-proxy to $ENV..."
        exec make deploy-chat-proxy ENVIRONMENT="$ENV"
        ;;
    proxies)
        echo "Deploying both proxies to $ENV..."
        make deploy-widget-proxy ENVIRONMENT="$ENV"
        exec make deploy-chat-proxy ENVIRONMENT="$ENV"
        ;;
    *)
        # Default: backend deployment via trigger-deploy.js
        exec node "$DEPLOY_DIR/trigger-deploy.js" "${ARGS[@]}"
        ;;
esac
