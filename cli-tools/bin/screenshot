#!/usr/bin/env bash
# screenshot - Wrapper for the E2E screenshot harness
# TAGS: system
# AUDIENCE: human, agent
#
# Usage: screenshot [route] [flags...]
#
# Examples:
#   screenshot                          # Default: /chat
#   screenshot chat                     # Screenshot /chat
#   screenshot onboarding               # Screenshot /onboarding
#   screenshot chat --mini              # Mini (collapsed) widget
#   screenshot chat --action open-settings
#   screenshot chat --describe          # JSON UI introspection
#   screenshot chat --viewport 375x812  # Custom viewport

set -euo pipefail

# Help
if [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    cat << 'EOF'
screenshot - Wrapper for the E2E Puppeteer screenshot harness

Usage: screenshot [route] [flags...]

Arguments:
  route     Route to screenshot (e.g. chat, onboarding, settings).
            Will have '/' prepended if not already present.
            Defaults to 'chat' if omitted.

Flags (passed through to node script):
  --mini                  Collapsed widget mode (no auto-expand)
  --describe              JSON UI introspection (actions, inputs, state)
  --action <name>         Execute an agentAPI action before capture
  --fill <name>=<value>   Fill an input before capture
  --viewport <WxH>        Custom viewport (e.g. 375x812, 1920x1080)
  --output <path>         Custom output file path
  --wait-for <selector>   Wait for CSS selector before capture
  --full-page             Full page capture

Output:
  stdout: screenshot file path (or JSON in --describe mode)
  stderr: auth/progress logs

Project detection (in priority order):
  1. cwd contains tests/e2e/screenshot.js
  2. git toplevel of cwd contains tests/e2e/screenshot.js
  3. Sibling ProcurementAgentAI-* worktrees in /home/token/ProcAgentDir/
  4. /home/token/ProcAgentDir/ProcurementAgentAI (canonical)

Examples:
  screenshot
  screenshot chat
  screenshot chat --mini
  screenshot onboarding --mini
  screenshot chat --action open-settings
  screenshot chat --describe
  screenshot chat --fill 'message-input=Hello' --action send-message
  screenshot chat --viewport 375x812
EOF
    exit 0
fi

# ── Project directory detection ──────────────────────────────────────────────

CANONICAL_DIR="/home/token/ProcAgentDir/ProcurementAgentAI"
PROJECT_DIR=""

# 1. Check if cwd itself contains the harness
if [[ -f "$(pwd)/tests/e2e/screenshot.js" ]]; then
    PROJECT_DIR="$(pwd)"
fi

# 2. Check git toplevel of cwd
if [[ -z "$PROJECT_DIR" ]] && git rev-parse --show-toplevel >/dev/null 2>&1; then
    GIT_ROOT="$(git rev-parse --show-toplevel)"
    if [[ -f "$GIT_ROOT/tests/e2e/screenshot.js" ]]; then
        PROJECT_DIR="$GIT_ROOT"
    fi
fi

# 3. Check sibling ProcurementAgentAI-* worktree directories
if [[ -z "$PROJECT_DIR" ]]; then
    PROC_AGENT_DIR="/home/token/ProcAgentDir"
    for dir in "$PROC_AGENT_DIR"/ProcurementAgentAI-*/; do
        if [[ -f "${dir}tests/e2e/screenshot.js" ]]; then
            PROJECT_DIR="${dir%/}"
            break
        fi
    done
fi

# 4. Fall back to canonical location
if [[ -z "$PROJECT_DIR" ]]; then
    PROJECT_DIR="$CANONICAL_DIR"
fi

HARNESS="$PROJECT_DIR/tests/e2e/screenshot.js"

if [[ ! -f "$HARNESS" ]]; then
    echo "Error: screenshot harness not found at $HARNESS" >&2
    echo "Is ProcurementAgentAI checked out at $CANONICAL_DIR?" >&2
    exit 1
fi

# ── Argument parsing ─────────────────────────────────────────────────────────

# First positional arg is the route; everything else is passed through
ROUTE=""
PASSTHROUGH_ARGS=()

for arg in "$@"; do
    if [[ -z "$ROUTE" ]] && [[ "$arg" != -* ]]; then
        ROUTE="$arg"
    else
        PASSTHROUGH_ARGS+=("$arg")
    fi
done

# Default route
if [[ -z "$ROUTE" ]]; then
    ROUTE="chat"
fi

# Prepend '/' if missing
if [[ "$ROUTE" != /* ]]; then
    ROUTE="/$ROUTE"
fi

# ── Execute ──────────────────────────────────────────────────────────────────

exec node "$HARNESS" "$ROUTE" "${PASSTHROUGH_ARGS[@]+"${PASSTHROUGH_ARGS[@]}"}"
