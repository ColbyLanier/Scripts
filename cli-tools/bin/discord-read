#!/usr/bin/env bash
# discord-read - Read Discord messages (DEPRECATED: use `discord read` instead)
# TAGS: claw, discord
# AUDIENCE: human, agent
#
# This script now wraps `discord read`. Use `discord read` directly.
#
# Usage: discord-read --channel <name-or-id> [--after <ISO-timestamp>] [--limit N] [--json]

set -euo pipefail

# Check if new daemon is available
if curl -sf "http://127.0.0.1:7779/status" >/dev/null 2>&1; then
  # Parse args to translate to new format
  CHANNEL="" LIMIT=25 JSON_FLAG="" AFTER=""
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --channel) CHANNEL="$2"; shift 2 ;;
      --after)   AFTER="$2"; shift 2 ;;
      --limit)   LIMIT="$2"; shift 2 ;;
      --json)    JSON_FLAG="--json"; shift ;;
      -h|--help) exec discord read --help ;;
      *) shift ;;
    esac
  done
  [[ -z "$CHANNEL" ]] && { echo "Error: --channel is required" >&2; exit 1; }

  ARGS=("$CHANNEL" --limit "$LIMIT")
  [[ -n "$AFTER" ]] && ARGS+=(--since "$AFTER")
  [[ -n "$JSON_FLAG" ]] && ARGS+=("$JSON_FLAG")

  exec discord read "${ARGS[@]}"
fi

# Legacy fallback: original openclaw-based implementation
echo "Warning: discord daemon not running, falling back to openclaw" >&2

# --- Channel aliases ---
resolve_channel() {
  case "$1" in
    general)       echo "1472713270916944020" ;;
    claw-chat)     echo "1472722308199219352" ;;
    tasks)         echo "1473154087490158656" ;;
    approvals)     echo "1473154111301091469" ;;
    alerts)        echo "1473154160202612831" ;;
    meta)          echo "1473154180200927264" ;;
    research)      echo "1473154201331699874" ;;
    operations)    echo "1473184628155088918" ;;
    interrogative) echo "1474963429902258176" ;;
    *) if [[ "$1" =~ ^[0-9]+$ ]]; then echo "$1"; else echo "Error: Unknown channel '$1'" >&2; exit 1; fi ;;
  esac
}

CHANNEL="" AFTER="" LIMIT=25 JSON_OUTPUT=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    --channel) CHANNEL="$2"; shift 2 ;;
    --after) AFTER="$2"; shift 2 ;;
    --limit) LIMIT="$2"; shift 2 ;;
    --json) JSON_OUTPUT=true; shift ;;
    *) shift ;;
  esac
done

[[ -z "$CHANNEL" ]] && { echo "Error: --channel is required" >&2; exit 1; }
CHANNEL_ID=$(resolve_channel "$CHANNEL")

command -v openclaw &>/dev/null || { echo "Error: openclaw not found" >&2; exit 1; }

RAW=$(openclaw message read --channel discord --target "channel:$CHANNEL_ID" --limit "$LIMIT" --json 2>/dev/null) || {
  echo "Error: Failed to read channel $CHANNEL" >&2; exit 1
}

if [[ -n "$AFTER" ]]; then
  RAW=$(echo "$RAW" | jq --arg after "$AFTER" '.payload.messages |= [.[] | select(.timestampUtc >= $after)]')
fi

if [[ "$JSON_OUTPUT" == true ]]; then
  echo "$RAW" | jq .
else
  echo "$RAW" | jq -r '.payload.messages[] | "[\(.timestampUtc[0:16] | gsub("T"; " "))] \(.author.username // "unknown"): \(.content)"' 2>/dev/null || {
    echo "No messages found." >&2; exit 1
  }
fi
