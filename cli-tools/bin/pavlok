#!/usr/bin/env python3
# pavlok - Quick Pavlok watch interface
# TAGS: token-api, pavlok
# AUDIENCE: human, agent
"""Quick Pavlok shock-watch interface via Token API.

Usage:
    pavlok                            # Show current status
    pavlok zap [value]                # Send zap (default: API default ~50)
    pavlok beep [value]               # Send beep
    pavlok vibe [value]               # Send vibration
    pavlok toggle                     # Toggle enabled on/off
    pavlok on                         # Enable
    pavlok off                        # Disable
    pavlok --raw                      # Raw JSON status
    pavlok -h, --help                 # Show this help

Value:
    1â€“100 intensity (optional, uses API default when omitted)

Reason:
    --reason TEXT                     # Reason label (default: "manual")

Examples:
    pavlok status                     # Show status
    pavlok beep 30                    # Beep at 30% intensity
    pavlok zap 75 --reason "break"    # Zap at 75% labeled "break"
    pavlok off                        # Disable Pavlok
"""

import sys
import json
import platform
import urllib.request
import urllib.error
import urllib.parse

if platform.system() == "Darwin":
    API_URL = "http://localhost:7777"
else:
    API_URL = "http://100.95.109.23:7777"

RESET  = "\033[0m"
RED    = "\033[31m"
GREEN  = "\033[32m"
YELLOW = "\033[33m"
CYAN   = "\033[36m"
BOLD   = "\033[1m"
DIM    = "\033[2m"

STIMULUS_ICONS = {
    "zap":  "âš¡",
    "beep": "ðŸ””",
    "vibe": "ðŸ“³",
}

STIMULUS_COLORS = {
    "zap":  RED,
    "beep": CYAN,
    "vibe": YELLOW,
}


def request(method, path, params=None):
    url = f"{API_URL}{path}"
    if params:
        url += "?" + urllib.parse.urlencode(params)
    req = urllib.request.Request(url, method=method)
    try:
        with urllib.request.urlopen(req, timeout=5) as resp:
            return json.loads(resp.read().decode())
    except urllib.error.HTTPError as e:
        body_text = e.read().decode()
        print(f"{RED}HTTP {e.code}: {body_text}{RESET}", file=sys.stderr)
        sys.exit(1)
    except urllib.error.URLError as e:
        print(f"{RED}Server unreachable: {e.reason}{RESET}", file=sys.stderr)
        sys.exit(1)


def fmt_bool(v):
    if v:
        return f"{GREEN}{BOLD}enabled{RESET}"
    return f"{RED}{BOLD}disabled{RESET}"


def fmt_cooldown(secs):
    if secs <= 0:
        return f"{GREEN}ready{RESET}"
    return f"{YELLOW}{secs:.0f}s cooldown{RESET}"


def show_status(data):
    enabled   = data.get("enabled", False)
    token_set = data.get("token_set", False)
    cooldown  = data.get("cooldown_remaining_seconds", 0)
    last_at   = data.get("last_stimulus_at")
    default_v = data.get("default_zap_value", "?")

    print(f"  Pavlok:      {fmt_bool(enabled)}")
    if not token_set:
        print(f"  Token:       {RED}not set â€” PAVLOK_API_TOKEN missing{RESET}")
    print(f"  Cooldown:    {fmt_cooldown(cooldown)}  {DIM}({data.get('cooldown_seconds', 30)}s window){RESET}")
    print(f"  Default val: {DIM}{default_v}{RESET}")
    if last_at:
        try:
            t = last_at.split("T")[1][:8] if "T" in last_at else last_at
        except Exception:
            t = last_at
        print(f"  Last stim:   {DIM}{t}{RESET}")


def main():
    args = sys.argv[1:]

    if "--help" in args or "-h" in args:
        print(__doc__.strip())
        return

    # Extract --reason
    reason = "manual"
    new_args = []
    i = 0
    while i < len(args):
        if args[i] == "--reason" and i + 1 < len(args):
            reason = args[i + 1]
            i += 2
        else:
            new_args.append(args[i])
            i += 1
    args = new_args

    raw = "--raw" in args
    args = [a for a in args if a != "--raw"]

    # No args or explicit "status" â†’ show status
    if not args or args[0] in ("status",):
        data = request("GET", "/api/pavlok/status")
        if raw:
            print(json.dumps(data, indent=2))
        else:
            show_status(data)
        return

    cmd = args[0].lower()

    # Toggle / on / off
    if cmd == "toggle":
        data = request("POST", "/api/pavlok/toggle")
        if raw:
            print(json.dumps(data, indent=2))
        else:
            enabled = data.get("enabled", data.get("status") == "enabled")
            print(f"  Pavlok: {fmt_bool(enabled)}")
        return

    if cmd == "on":
        data = request("POST", "/api/pavlok/toggle", {"enabled": "true"})
        if raw:
            print(json.dumps(data, indent=2))
        else:
            print(f"  Pavlok: {fmt_bool(True)}")
        return

    if cmd == "off":
        data = request("POST", "/api/pavlok/toggle", {"enabled": "false"})
        if raw:
            print(json.dumps(data, indent=2))
        else:
            print(f"  Pavlok: {fmt_bool(False)}")
        return

    # Stimulus commands
    if cmd in ("zap", "beep", "vibe"):
        params = {"type": cmd, "reason": reason}
        if len(args) >= 2:
            try:
                val = int(args[1])
                if not 1 <= val <= 100:
                    print(f"{RED}Value must be 1â€“100, got {val}{RESET}", file=sys.stderr)
                    sys.exit(1)
                params["value"] = val
            except ValueError:
                print(f"{RED}Invalid value: {args[1]!r} (must be integer 1â€“100){RESET}", file=sys.stderr)
                sys.exit(1)

        data = request("POST", "/api/pavlok/zap", params)
        if raw:
            print(json.dumps(data, indent=2))
        else:
            icon  = STIMULUS_ICONS.get(cmd, "?")
            color = STIMULUS_COLORS.get(cmd, "")
            val_s = f" @ {params['value']}%" if "value" in params else ""
            print(f"  {icon} {color}{BOLD}{cmd}{RESET}{val_s}  {DIM}({reason}){RESET}")
        return

    print(f"{RED}Unknown command: {cmd!r}{RESET}", file=sys.stderr)
    print(f"Run 'pavlok --help' for usage.", file=sys.stderr)
    sys.exit(1)


if __name__ == "__main__":
    main()
